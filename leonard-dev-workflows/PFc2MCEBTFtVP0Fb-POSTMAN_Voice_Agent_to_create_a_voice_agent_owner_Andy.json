{
  "name": "POSTMAN - Voice Agent to create a voice agent - owner Andy",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "=Call sumamry here: {{ $json.body.data.analysis.transcript_summary }}\nCall transcript here: {{ $json.body.data.transcript }}",
        "options": {
          "systemMessage": "=You are the **Voice Agent Creation Agent**.\n\nYour job is to take structured input describing the desired purpose, tone, behaviour, and technical requirements of a new ElevenLabs voice agent ‚Äî and return a **single, valid JSON object** that is 100% syntactically correct and ready for use inside an n8n workflow.\n\n---\n\n### üéØ YOUR OUTPUT REQUIREMENTS\n\nYou must output **only** a single JSON object that matches the following schema:\n\n```json\n{\n  \"status\": \"success\",\n  \"agent_prompt\": \"string\"\n}\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        432,
        -400
      ],
      "id": "d1cac6c0-eba5-4819-9bc1-8c2453c68f95",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "projectId": {
          "__rl": true,
          "value": "vertex-ai-api-setup-via-cli",
          "mode": "id"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleVertex",
      "typeVersion": 1,
      "position": [
        512,
        -176
      ],
      "id": "f6134f9b-199f-42d8-a096-41b95931e221",
      "name": "Google Vertex Chat Model",
      "credentials": {
        "googleApi": {
          "id": "LQjM9YuYI3HxJBrE",
          "name": "Google Service Account - Edu account Oct 8th"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.elevenlabs.io/v1/convai/agents/create",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "xi-api-key",
              "value": "sk_3eca705a3c2780af4cb1116beb64d3e1d3bfc187a8d565f8"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"agent_id\": \"agent_0201k4b73d15egvvd88yqxzvz19g\",\n  \"name\": \"Custom Agentic AI Agent Baldrick - [owner: Andy] - {{ $('Webhook1').item.json.body.data.conversation_initiation_client_data.dynamic_variables.system__time }}\",\n  \"conversation_config\": {\n    \"asr\": {\"quality\": \"high\", \"provider\": \"elevenlabs\", \"user_input_audio_format\": \"pcm_16000\", \"keywords\": []},\n    \"turn\": {\"turn_timeout\": 10.0, \"silence_end_call_timeout\": -1.0, \"mode\": \"turn\"},\n    \"tts\": {\"model_id\": \"eleven_flash_v2\", \"voice_id\": \"AwP2bjcqrSky0yiDhZSe\", \"supported_voices\": [], \"agent_output_audio_format\": \"pcm_16000\", \"optimize_streaming_latency\": 4, \"stability\": 0.65, \"speed\": 0.99, \"similarity_boost\": 0.45, \"pronunciation_dictionary_locators\": []},\n    \"conversation\": {\"text_only\": false, \"max_duration_seconds\": 3600, \"client_events\": [\"audio\", \"interruption\"]},\n    \"language_presets\": {},\n    \"agent\": {\n      \"first_message\": \"Hi, I'm Baldrick, your super smart bespoke Agentic AI Voice Agent. I hear you're interested in creating a voice agent to help you with a task so let's get going. What do you want to start with?\",\n      \"language\": \"en\",\n      \"dynamic_variables\": {\"dynamic_variable_placeholders\": {}},\n      \"prompt\": {\n        \"prompt\": \"{{ $json.agent_prompt }}\",\n        \"llm\": \"gemini-2.5-flash-lite\",\n        \"temperature\": 0.3,\n        \"max_tokens\": -1,\n        \"tool_ids\": [],\n        \"built_in_tools\": {\n          \"end_call\": {\"type\": \"system\", \"name\": \"end_call\", \"description\": \"\", \"response_timeout_secs\": 20, \"disable_interruptions\": false, \"force_pre_tool_speech\": false, \"assignments\": [], \"params\": {\"system_tool_type\": \"end_call\"}},\n          \"language_detection\": null,\n          \"transfer_to_agent\": null,\n          \"transfer_to_number\": null,\n          \"skip_turn\": null,\n          \"play_keypad_touch_tone\": null,\n          \"voicemail_detection\": {\"type\": \"system\", \"name\": \"voicemail_detection\", \"description\": \"\", \"response_timeout_secs\": 20, \"disable_interruptions\": false, \"force_pre_tool_speech\": false, \"assignments\": [], \"params\": {\"system_tool_type\": \"voicemail_detection\", \"voicemail_message\": \"\"}}\n        },\n        \"mcp_server_ids\": [],\n        \"native_mcp_server_ids\": [],\n        \"knowledge_base\": [],\n        \"custom_llm\": null,\n        \"ignore_default_personality\": false,\n        \"rag\": {\"enabled\": true, \"embedding_model\": \"e5_mistral_7b_instruct\", \"max_vector_distance\": 0.6, \"max_documents_length\": 50000, \"max_retrieved_rag_chunks_count\": 20},\n        \"timezone\": null,\n        \"tools\": [\n          {\"type\": \"system\", \"name\": \"end_call\", \"description\": \"\", \"response_timeout_secs\": 20, \"disable_interruptions\": false, \"force_pre_tool_speech\": false, \"assignments\": [], \"params\": {\"system_tool_type\": \"end_call\"}},\n          {\"type\": \"system\", \"name\": \"voicemail_detection\", \"description\": \"\", \"response_timeout_secs\": 20, \"disable_interruptions\": false, \"force_pre_tool_speech\": false, \"assignments\": [], \"params\": {\"system_tool_type\": \"voicemail_detection\", \"voicemail_message\": \"\"}}\n        ]\n      }\n    }\n  },\n  \"metadata\": {\"created_at_unix_secs\": 1757018174, \"updated_at_unix_secs\": 1757018174},\n  \"platform_settings\": {\"auth\": {\"enable_auth\": false, \"allowlist\": [], \"shareable_token\": null}, \"evaluation\": {\"criteria\": []}, \"widget\": {\"variant\": \"full\", \"placement\": \"bottom-right\", \"expandable\": \"never\", \"avatar\": {\"type\": \"orb\", \"color_1\": \"#2792dc\", \"color_2\": \"#9ce6e6\"}, \"feedback_mode\": \"during\", \"bg_color\": \"#ffffff\", \"text_color\": \"#000000\", \"btn_color\": \"#000000\", \"btn_text_color\": \"#ffffff\", \"border_color\": \"#e1e1e1\", \"focus_color\": \"#000000\", \"border_radius\": null, \"btn_radius\": null, \"action_text\": null, \"start_call_text\": null, \"end_call_text\": null, \"expand_text\": null, \"listening_text\": null, \"speaking_text\": null, \"shareable_page_text\": null, \"shareable_page_show_terms\": false, \"terms_text\": null, \"terms_html\": null, \"terms_key\": null, \"show_avatar_when_collapsed\": false, \"disable_banner\": false, \"override_link\": null, \"mic_muting_enabled\": false, \"transcript_enabled\": false, \"text_input_enabled\": false, \"default_expanded\": false, \"always_expanded\": false, \"text_contents\": {\"main_label\": \"Chat to your Agent ?\", \"start_call\": \"Chat now\", \"start_chat\": null, \"new_call\": null, \"end_call\": null, \"mute_microphone\": null, \"change_language\": null, \"collapse\": null, \"expand\": null, \"copied\": null, \"accept_terms\": null, \"dismiss_terms\": null, \"listening_status\": null, \"speaking_status\": null, \"connecting_status\": null, \"chatting_status\": null, \"input_label\": null, \"input_placeholder\": null, \"input_placeholder_text_only\": null, \"input_placeholder_new_conversation\": null, \"user_ended_conversation\": null, \"agent_ended_conversation\": null, \"conversation_id\": null, \"error_occurred\": null, \"copy_id\": null}, \"styles\": {\"base\": null, \"base_hover\": null, \"base_active\": null, \"base_border\": null, \"base_subtle\": null, \"base_primary\": null, \"base_error\": null, \"accent\": null, \"accent_hover\": null, \"accent_active\": null, \"accent_border\": null, \"accent_subtle\": null, \"accent_primary\": null, \"overlay_padding\": null, \"button_radius\": null, \"input_radius\": null, \"bubble_radius\": null, \"sheet_radius\": null, \"compact_sheet_radius\": null, \"dropdown_sheet_radius\": null}, \"language_selector\": false, \"supports_text_only\": false, \"custom_avatar_path\": null, \"language_presets\": {}}, \"data_collection\": {}, \"overrides\": {\"conversation_config_override\": {\"tts\": {\"voice_id\": false, \"stability\": false, \"speed\": false, \"similarity_boost\": false}, \"conversation\": {\"text_only\": true}, \"agent\": {\"first_message\": false, \"language\": false, \"prompt\": {\"prompt\": false, \"native_mcp_server_ids\": false}}}, \"custom_llm_extra_body\": false, \"enable_conversation_initiation_client_data_from_webhook\": false}, \"call_limits\": {\"agent_concurrency_limit\": -1, \"daily_limit\": 100000, \"bursting_enabled\": true}, \"ban\": null, \"privacy\": {\"record_voice\": true, \"retention_days\": -1, \"delete_transcript_and_pii\": false, \"delete_audio\": false, \"apply_to_existing_conversations\": false, \"zero_retention_mode\": false}, \"workspace_overrides\": {\"conversation_initiation_client_data_webhook\": null, \"webhooks\": {\"post_call_webhook_id\": \"\", \"send_audio\": false}}, \"testing\": {\"attached_tests\": [], \"referenced_tests_ids\": []}, \"safety\": {\"is_blocked_ivc\": false, \"is_blocked_non_ivc\": false, \"ignore_safety_evaluation\": false}},\n  \"phone_numbers\": [],\n  \"workflow\": {\"edges\": {}, \"nodes\": {\"start_node\": {\"type\": \"start\", \"position\": {\"x\": 0.0, \"y\": 0.0}}}}\n"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        1008,
        -304
      ],
      "id": "feeb924d-dff4-423c-b5cd-0a843ea2db65",
      "name": "Create 11L agent with KB1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "voice_agent_creates_a_voice_agent",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -16,
        -304
      ],
      "id": "b635be2b-3f4c-4b6a-8600-3c6388260be2",
      "name": "Webhook1"
    },
    {
      "parameters": {
        "toRecipients": "=leonard@legalengine.co.uk, andy@legalengine.co.uk, {{ $('AI Agent2').item.json.output }}",
        "subject": "=Your bespoke voice agent ",
        "bodyContent": "=<!doctype html>\n<html lang=\"en\" style=\"margin:0;padding:0;\">\n  <!-- keep your full HTML here as before -->\n</html>\n",
        "additionalFields": {
          "bodyContentType": "html"
        }
      },
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        1904,
        -304
      ],
      "id": "ac018882-bc07-441d-a50a-6da6366fc470",
      "name": "HTML Email to user1",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "eweG9vjyeWb4mfPE",
          "name": "Microsoft Outlook - Support @ Legal Engine"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "10d0d682-5b65-41ab-8541-cd65011e7e15",
              "leftValue": "={{ $json.body.data.conversation_initiation_client_data.dynamic_variables.system__call_duration_secs }}",
              "rightValue": 45,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        208,
        -304
      ],
      "id": "d6b622a9-dce8-42b1-9983-4976560e2771",
      "name": "If1"
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        2128,
        -304
      ],
      "id": "69d61aa8-9c86-4505-a567-c1a51aa9d92d",
      "name": "Wait1"
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://api.elevenlabs.io/v1/convai/agents/{{ $('Create 11L agent with KB1').item.json.agent_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "xi-api-key",
              "value": "sk_3eca705a3c2780af4cb1116beb64d3e1d3bfc187a8d565f8"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        2352,
        -304
      ],
      "id": "25b5e470-b2df-4840-adf1-49263ebd7b62",
      "name": "Delete Agent1"
    },
    {
      "parameters": {
        "jsCode": "// === Voice Agent JSON Sanitiser ===\nlet raw = $json.output || $json.data || $input.item.json.text || \"\";\nraw = raw.trim()\n  .replace(/^```json/i, \"\")\n  .replace(/^```/, \"\")\n  .replace(/```$/, \"\")\n  .replace(/[\\u0000-\\u001F]+/g, \" \")\n  .trim();\nconst firstBrace = raw.indexOf(\"{\");\nconst lastBrace = raw.lastIndexOf(\"}\");\nif (firstBrace > -1 && lastBrace > firstBrace) raw = raw.slice(firstBrace, lastBrace + 1);\nlet parsed;\ntry { parsed = JSON.parse(raw); } catch (err) {\n  let repaired = raw.replace(/\\n+/g, \" \").replace(/\\r+/g, \" \")\n    .replace(/\\\\(?![\"\\\\/bfnrtu])/g, \"\\\\\\\\\")\n    .replace(/‚Äú|‚Äù/g, '\"').replace(/‚Äò|‚Äô/g, \"'\");\n  try { parsed = JSON.parse(repaired); } catch { return [{ json: { status: \"error\", message: \"Invalid or unrepairable JSON\", raw_response: raw } }]; }\n}\nif (!parsed || typeof parsed !== \"object\") return [{ json: { status: \"error\", message: \"Output not an object\", raw_response: raw } }];\nif (!parsed.agent_prompt || typeof parsed.agent_prompt !== \"string\") { parsed.status = \"error\"; parsed.message = \"Missing or invalid agent_prompt\"; }\nif (parsed.agent_prompt) parsed.agent_prompt = parsed.agent_prompt.replace(/\\s+/g, \" \").replace(/\\\\n/g, \" \").replace(/[\\\"]+/g, '\"').trim();\nreturn [{ json: { status: parsed.status || \"success\", agent_prompt: parsed.agent_prompt || \"\", validated: true } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        -304
      ],
      "id": "506dbec0-4de5-4f19-ba76-9b7737f3e8ea",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        1680,
        -304
      ],
      "id": "7174de68-ed0d-4922-b0b1-4cede77692a0",
      "name": "Wait2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Email address if validated here: \n{{ $('If1').item.json.body.data.analysis.data_collection_results.email_address.value }}\nRationale for decision on email address here:\n{{ $('If1').item.json.body.data.analysis.data_collection_results.email_address.rationale }}",
        "options": {
          "systemMessage": "=Take the inputs and produce the most likely email address that the user is trying to give to the voice agent in particular paying attention to the word 'at' which is likely to actually be a @.\n\nOutput is a well formulated email address."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1248,
        -304
      ],
      "id": "62eeeebe-8db3-451b-bdf3-0aa287d6a056",
      "name": "AI Agent2"
    },
    {
      "parameters": {
        "projectId": {
          "__rl": true,
          "value": "vertex-ai-api-setup-via-cli",
          "mode": "id"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleVertex",
      "typeVersion": 1,
      "position": [
        1264,
        -128
      ],
      "id": "d30a38d7-8e17-48d6-be0e-94a2125f4945",
      "name": "Google Vertex Chat Model1",
      "credentials": {
        "googleApi": {
          "id": "LQjM9YuYI3HxJBrE",
          "name": "Google Service Account - Edu account Oct 8th"
        }
      }
    }
  ],
  "connections": {
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Vertex Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Create 11L agent with KB1": {
      "main": [
        [
          {
            "node": "AI Agent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML Email to user1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [],
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Delete Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Create 11L agent with KB1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "HTML Email to user1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Vertex Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent2": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 0,
  "meta": null
}