{
  "name": "DEV - S1 - Luke Pre Day Summary of meetings today",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 5
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -336,
        -576
      ],
      "id": "c1289170-86f5-418d-9349-ca936bc388d9",
      "name": "Schedule Trigger",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -112,
        -480
      ],
      "id": "01595660-0755-4450-83ec-0c4bcb8e14a2",
      "name": "Today"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "f2141cf2-1196-4521-b206-00def7b641ff",
              "leftValue": "",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "50ec4c6e-c885-4394-8a05-8e17d89e3c8d",
      "name": "IF ‚Äî No meetings today?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        784,
        -384
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Use the Perplexity Search tool to perform the following task robustly: \n\nResearch this person ahead of a business meeting subject: {{ $json.meetingSubject }}.\n\nAttendee's name is {{ $json.name }}, their email address is {{ $json.email }}. Their Company name is likely to be similar to {{ $json.company }} with company domain: www.{{ $json.domain }}. If the {{ $json.name }} is actually an email address infer what their name would be and use that to search for them based on the company name {{ $json.company }}.\n\nThese details should ensure you can locate them on linkedin, their official company web page or on professional networks or from more public sources.\n\nUse a range of search options to establish a robust bio for the attendee, who is due to meet with Lee Curtis from Legal Engine - https://www.linkedin.com/in/leeacurtis/ www.legalengine.co.uk. You should be robust in finding out their entire professional background.\n\nOnly use the Perplexity Search tool once per person. Focus on LinkedIn as a key source of information and connections of Lee Curtis to help to identify meeting attendees. Use variations of the names of attendees if no information is found as it's highly unlikley that attendees won't have a linkedin proifile. Also search for matches on UK Companies House (https://find-and-update.company-information.service.gov.uk/company/13160418/officers).\n\nIf there is still no record, look for similar names to {{ $json.name }} using a fuzzy search on the name who work at {{ $json.company }} and are related to or work within law or professional services.",
        "options": {
          "systemMessage": "You write compact, factual bios for meeting prep in UK English. Avoid speculation. Prefer official pages, LinkedIn, company sites, or major press. Return a compact 4‚Äì6 sentence bio (UK English), 2‚Äì3 recent items with dates, and 2‚Äì3 credible links. Keep it under 150 words per person. ",
          "returnIntermediateSteps": false
        }
      },
      "id": "309819bc-7366-4b70-b89a-770143799a81",
      "name": "Research Attendee (Agent)",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1456,
        -384
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Generate a mobile-friendly HTML day briefing from merged calendar data\n// Accepts mixed shapes (either your merged event objects OR ai_event wrappers).\n// Returns ONE item with { html, subject }.\n//\n// It handles:\n// - time: ev.time.{startISO,endISO,display,timeZone,durationMinutes} OR flat startISO/endISO/timeZone\n// - organizer: ev.organizer{name,email} OR organizerName/organizerEmail\n// - attendees: ev.attendeesAll / attendeesInternal / attendeesExternal OR single-attendee fields\n// - external bios: ev.externalAttendeeBios OR attendees with `bio`\n// - location: ev.location (string or {name})\n// - links: ev.meetingLink / ev.webLink\n//\n// Sorts meetings by start time and prints: time range, subject (linked), location/link, organizer,\n// internal & external attendees, and per-external bio (trimmed to ~120 words).\n\n//////////////////// helpers ////////////////////\nfunction clean(s){ return typeof s === 'string' ? s.trim() : ''; }\nfunction lower(s){ return typeof s === 'string' ? s.toLowerCase() : ''; }\nfunction get(o, p, d){\n  var parts = p.split('.'); var cur = o;\n  for (var i=0;i<parts.length;i++){ var k = parts[i]; if (cur && typeof cur==='object' && (k in cur)) cur = cur[k]; else return d; }\n  return cur;\n}\nfunction domainFromEmail(email){ var e = lower(clean(email)); var at = e.indexOf('@'); return at>-1 ? e.slice(at+1) : ''; }\nfunction normalizeIso(s){\n  s = clean(s); if (!s) return null;\n  var t = s.replace(/Z$/,''); var dot = t.indexOf('.'); if (dot>-1) t = t.slice(0, dot);\n  if (t.length >= 19) t = t.slice(0,19); // YYYY-MM-DDTHH:MM:SS\n  return t;\n}\nfunction hhmm(iso){ return (iso && iso.length>=16) ? iso.slice(11,16) : ''; }\nfunction ymd(iso){ return (iso && iso.length>=10) ? iso.slice(0,10) : null; }\nfunction parseUTCDate(iso){ // treat ISO (without Z) as UTC for header formatting\n  if (!iso) return null;\n  try { return new Date(iso + 'Z'); } catch(_) { return null; }\n}\nfunction headerDateString(date){\n  // Friday 30 Aug 2025\n  var DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];\n  var MOS  = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];\n  if (!date) date = new Date();\n  var d = date.getUTCDate();\n  var dow = DAYS[date.getUTCDay()];\n  var mo = MOS[date.getUTCMonth()];\n  var yr = date.getUTCFullYear();\n  return dow + ' ' + String(d).padStart(2,'0') + ' ' + mo + ' ' + yr;\n}\nfunction wordsClamp(text, maxWords){\n  var ws = clean(text).split(/\\s+/).filter(Boolean);\n  if (ws.length <= maxWords) return ws.join(' ');\n  return ws.slice(0, maxWords).join(' ') + '‚Ä¶';\n}\nfunction uniqBy(arr, keyFn){\n  var seen = {}; var out = [];\n  for (var i=0;i<arr.length;i++){\n    var k = keyFn(arr[i]);\n    if (k && !seen[k]){ seen[k] = 1; out.push(arr[i]); }\n    if (!k) out.push(arr[i]);\n  }\n  return out;\n}\n\nfunction deriveTimes(ev){\n  var t = ev.time || {};\n  var startISO = normalizeIso(t.startISO || ev.startISO || get(ev,'start.dateTime', null) || (typeof ev.start === 'string' ? ev.start : null));\n  var endISO   = normalizeIso(t.endISO   || ev.endISO   || get(ev,'end.dateTime',   null) || (typeof ev.end   === 'string' ? ev.end   : null));\n  var tz = t.timeZone || ev.timeZone || get(ev,'start.timeZone','UTC');\n  var display = t.display || (ev.display || (ev.isAllDay ? 'All day' : (hhmm(startISO) + ((startISO && endISO)?'-':'') + hhmm(endISO))));\n  var durationMinutes = (typeof t.durationMinutes === 'number') ? t.durationMinutes : (typeof ev.durationMinutes === 'number' ? ev.durationMinutes : null);\n  return { startISO:startISO, endISO:endISO, display:display, timeZone:tz, durationMinutes:durationMinutes };\n}\nfunction normalizeAttendee(a){\n  a = a || {};\n  var email = clean(a.email || get(a,'emailAddress.address',''));\n  var name  = clean(a.name  || get(a,'emailAddress.name','') || (email ? email.split('@')[0] : ''));\n  var domain = clean(a.domain || domainFromEmail(email));\n  var response = clean(a.response || get(a,'status.response','') || '');\n  var bio = clean(a.bio || a.output || '');\n  return { name:name, email:email, domain:domain, response:response, bio:bio };\n}\nfunction summarizeAttendeeList(list){\n  if (!list || !list.length) return '‚Äî';\n  return list.map(function(a){ return clean(a.name || a.email || ''); }).filter(Boolean).join(', ');\n}\nfunction eventKey(ev){\n  var id = ev.id || ev.eventId || '';\n  var s = get(ev,'time.startISO', ev.startISO || '') || '';\n  var subj = clean(ev.subject || ev.Subject || '');\n  return (id ? 'id:'+id : 'k:'+subj+'|'+s);\n}\n\n//////////////////// collect & normalize ////////////////////\nvar rows = $input.all().map(function(i){ return i.json; });\n\n// If upstream produced ai_event wrapper, unwrap to a consistent event shape\nvar events = rows.map(function(x){\n  return x && x.ai_event ? x.ai_event : x;\n});\n\n// Aggregate in case upstream still sends per-attendee items\nvar grouped = {};\nfor (var i=0;i<events.length;i++){\n  var ev = events[i] || {};\n  var key = eventKey(ev);\n  if (!grouped[key]){\n    grouped[key] = {\n      id: ev.id || ev.eventId || null,\n      subject: clean(ev.subject || ev.Subject || '(No subject)'),\n      isAllDay: !!ev.isAllDay,\n      time: deriveTimes(ev),\n      organizer: {\n        name: clean(get(ev,'organizer.name', ev.organizerName || '')),\n        email: clean(get(ev,'organizer.email', ev.organizerEmail || ''))\n      },\n      internalDomain: clean(ev.internalDomain || domainFromEmail(get(ev,'organizer.email', ev.organizerEmail || ''))),\n      location: (get(ev,'location.name', null) || (typeof ev.location==='string' ? ev.location : null)) || '',\n      meetingLink: ev.meetingLink || null,\n      webLink: ev.webLink || null,\n      description: clean(ev.contextHint || ev.description || ev.bodyPreview || ''),\n      attendeesAll: [],\n      externalAttendeeBios: Array.isArray(ev.externalAttendeeBios) ? ev.externalAttendeeBios.slice() : []\n    };\n  }\n  // Merge attendees from any shape\n  if (Array.isArray(ev.attendeesAll) && ev.attendeesAll.length){\n    grouped[key].attendeesAll = grouped[key].attendeesAll.concat(ev.attendeesAll.map(normalizeAttendee));\n  } else if (Array.isArray(ev.attendees) && ev.attendees.length){\n    grouped[key].attendeesAll = grouped[key].attendeesAll.concat(ev.attendees.map(normalizeAttendee));\n  } else if (ev.attendeeEmail || ev.attendeeName){\n    grouped[key].attendeesAll.push(normalizeAttendee({ email: ev.attendeeEmail, name: ev.attendeeName, domain: ev.attendeeDomain, response: ev.attendeeResponse, bio: ev.bio }));\n  }\n  // Merge bios if present on attendeesExternal\n  if (Array.isArray(ev.attendeesExternal)){\n    for (var j=0;j<ev.attendeesExternal.length;j++){\n      var a = normalizeAttendee(ev.attendeesExternal[j]);\n      if (a.bio) grouped[key].externalAttendeeBios.push({ name:a.name||a.email, email:a.email||'', domain:a.domain||'', bio:a.bio });\n    }\n  }\n}\n\n// Deduplicate attendees & bios, split internal/external\nvar meetings = [];\nfor (var k in grouped){\n  var g = grouped[k];\n  g.attendeesAll = uniqBy(g.attendeesAll, function(a){ return lower(a.email); });\n  var internal = []; var external = [];\n  for (var i2=0;i2<g.attendeesAll.length;i2++){\n    var a2 = g.attendeesAll[i2];\n    if (a2.domain && g.internalDomain && lower(a2.domain) === lower(g.internalDomain)) internal.push(a2);\n    else external.push(a2);\n  }\n  // Normalize bios: prefer explicit externalAttendeeBios, else from external attendees\n  var bios = [];\n  if (Array.isArray(g.externalAttendeeBios) && g.externalAttendeeBios.length){\n    for (var b=0;b<g.externalAttendeeBios.length;b++){\n      var eb = g.externalAttendeeBios[b] || {};\n      if (clean(eb.bio)) bios.push({ name: clean(eb.name||eb.email||''), email: clean(eb.email||''), domain: clean(eb.domain||''), bio: clean(eb.bio) });\n    }\n  } else {\n    for (var e=0;e<external.length;e++){\n      var ex = external[e];\n      if (ex.bio) bios.push({ name: ex.name||ex.email||'', email: ex.email||'', domain: ex.domain||'', bio: ex.bio });\n    }\n  }\n  // trim bios to ~120 words\n  for (var bb=0;bb<bios.length;bb++){ bios[bb].bio = wordsClamp(bios[bb].bio, 120); }\n\n  meetings.push({\n    id: g.id, subject: g.subject, isAllDay: g.isAllDay, time: g.time,\n    organizer: g.organizer, internalDomain: g.internalDomain,\n    location: g.location, meetingLink: g.meetingLink, webLink: g.webLink,\n    description: g.description,\n    attendeesInternal: internal, attendeesExternal: external,\n    bios: bios\n  });\n}\n\n// Sort by start time\nmeetings.sort(function(a,b){\n  var as = a.time.startISO || ''; var bs = b.time.startISO || '';\n  return as < bs ? -1 : (as > bs ? 1 : 0);\n});\n\n// Header date from earliest meeting start, fallback to today\nvar headerDate = (meetings[0] && meetings[0].time && meetings[0].time.startISO) ? parseUTCDate(meetings[0].time.startISO) : new Date();\nvar headerText = headerDateString(headerDate);\n\n// Build HTML\nfunction esc(s){\n  return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');\n}\nfunction linkify(label, href){\n  if (!href) return esc(label);\n  return '<a href=\"'+esc(href)+'\" target=\"_blank\" rel=\"noopener noreferrer\">'+esc(label)+'</a>';\n}\n\nvar htmlParts = [];\nhtmlParts.push(\n'<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">',\n'<title>Start-of-day Briefing ‚Äî '+esc(headerText)+'</title>',\n'<style>',\n'body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;background:#fafafa;}',\n'.wrap{max-width:720px;margin:0 auto;padding:16px;}',\n'.hdr{position:sticky;top:0;background:#fff;padding:12px 16px;margin:0 -16px 16px;border-bottom:1px solid #eee;z-index:10;}',\n'.hdr h1{font-size:20px;margin:0;}',\n'.mtg{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px 14px 12px;margin:12px 0;box-shadow:0 1px 1px rgba(0,0,0,0.02);}',\n'.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:#333;font-size:13px;}',\n'.time{font-weight:600;color:#0b5cff;}',\n'.subj{font-size:16px;font-weight:700;margin:4px 0 6px 0;}',\n'.meta{color:#555;font-size:13px;margin:2px 0 8px 0;}',\n'.pill{display:inline-block;background:#f1f5ff;color:#0b5cff;border-radius:999px;padding:2px 8px;font-size:12px;margin:2px 6px 0 0;}',\n'.bios{border-top:1px solid #f0f0f0;margin-top:10px;padding-top:10px;}',\n'.bio{margin:8px 0;}',\n'.bio .name{font-weight:600;}',\n'a{color:#0b5cff;text-decoration:none} a:hover{text-decoration:underline}',\n'</style></head><body><div class=\"wrap\">',\n'<div class=\"hdr\"><h1>Start-of-day Briefing ‚Äî '+esc(headerText)+'</h1></div>'\n);\n\nif (!meetings.length){\n  htmlParts.push('<p>No meetings found for this day.</p>');\n} else {\n  for (var i3=0;i3<meetings.length;i3++){\n    var m = meetings[i3];\n    var t = m.time || {};\n    var timeLabel = m.isAllDay ? 'All day' : ((t.display || ((hhmm(t.startISO)||'') + ((t.startISO&&t.endISO)?'-':'') + (hhmm(t.endISO)||''))) + (t.timeZone ? ' '+t.timeZone : ''));\n    var subjectLine = esc(m.subject);\n    var href = m.meetingLink || m.webLink || '';\n    var subjectHtml = href ? linkify(subjectLine, href) : subjectLine;\n    var loc = m.location ? esc(m.location) : '';\n    var org = (m.organizer && (m.organizer.name || m.organizer.email)) ? esc([m.organizer.name, m.organizer.email ? '<'+m.organizer.email+'>' : ''].filter(Boolean).join(' ')) : '';\n    var internalList = summarizeAttendeeList(m.attendeesInternal);\n    var externalList = summarizeAttendeeList(m.attendeesExternal);\n\n    htmlParts.push('<section class=\"mtg\">');\n    htmlParts.push('<div class=\"row\"><span class=\"time\">'+esc(timeLabel)+'</span></div>');\n    htmlParts.push('<div class=\"subj\">'+subjectHtml+'</div>');\n    var metaBits = [];\n    if (loc) metaBits.push('üìç '+loc);\n    if (org) metaBits.push('üë§ '+org);\n    if (t.durationMinutes) metaBits.push('‚è± '+t.durationMinutes+' min');\n    if ((m.meetingLink || m.webLink) && !href){\n      var linksLine = [m.meetingLink, m.webLink].filter(Boolean).map(function(u){ return linkify('link', u); }).join(' ¬∑ ');\n      metaBits.push('üîó '+linksLine);\n    }\n    if (metaBits.length) htmlParts.push('<div class=\"meta\">'+metaBits.join(' &nbsp;¬∑&nbsp; ')+'</div>');\n\n    htmlParts.push('<div class=\"meta\"><span class=\"pill\">Internal</span> '+esc(internalList)+'</div>');\n    htmlParts.push('<div class=\"meta\"><span class=\"pill\">External</span> '+esc(externalList)+'</div>');\n\n    if (m.bios && m.bios.length){\n      htmlParts.push('<div class=\"bios\"><div class=\"meta\" style=\"margin-bottom:6px;\">Background</div>');\n      for (var b2=0;b2<m.bios.length;b2++){\n        var b = m.bios[b2];\n        var nm = esc(b.name || b.email || '');\n        var email = b.email ? ' &lt;'+esc(b.email)+'&gt;' : '';\n        var dom = b.domain ? ' ‚Äî '+esc(b.domain) : '';\n        var bioTxt = esc(b.bio);\n        htmlParts.push('<div class=\"bio\"><div class=\"name\">', nm, email, dom, '</div><div class=\"txt\">', bioTxt, '</div></div>');\n      }\n      htmlParts.push('</div>');\n    }\n    htmlParts.push('</section>');\n  }\n}\n\nhtmlParts.push('</div></body></html>');\nvar html = htmlParts.join('');\n\nvar subjOut = 'Start-of-day Briefing ‚Äî ' + headerText;\nreturn [{ json: { html: html, subject: subjOut, meetingCount: meetings.length } }];\n"
      },
      "id": "2fb5c4cf-3820-420b-b5e6-8e965bcbeb5a",
      "name": "Generate HTML Briefing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2672,
        -480
      ],
      "disabled": true
    },
    {
      "parameters": {
        "toRecipients": "andy@legalengine.co.uk",
        "subject": "=Meeting today",
        "bodyContent": "={{ $json.output }}",
        "additionalFields": {
          "bodyContentType": "html",
          "saveToSentItems": true
        }
      },
      "id": "946723e8-7362-4702-9b9a-38dea9f3a22b",
      "name": "Send Briefing (Outlook, HTML)",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        2960,
        -624
      ],
      "webhookId": "3ef26eac-a9d2-420e-91fa-0bb62569757d",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "NEL55RMRYkKmOgp4",
          "name": "Microsoft Outlook - Andy"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "resource": "event",
        "filters": {
          "custom": "=start/dateTime ge '{{ $('Today').item.json.currentDate }}' and start/dateTime lt '{{ $json.newDate }}'\n"
        }
      },
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        336,
        -480
      ],
      "id": "d9937a14-2854-4568-bc7d-aa74af7ef504",
      "name": "Get many events",
      "webhookId": "02d09593-ebd5-4249-bca7-eb07a016969a",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "6M8EKjo0xkpyROgs",
          "name": "Microsoft Outlook - Lee @ Legal Engine"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-mini-2025-08-07",
          "mode": "list",
          "cachedResultName": "gpt-5-mini-2025-08-07"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1472,
        -160
      ],
      "id": "86ff87b8-ae6a-4850-b70d-0ed75fed94d5",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "LldOhLNBReShSMkE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "sonar-reasoning",
        "messages": {
          "message": [
            {
              "content": "=You are a research assistant for meeting prep. Task: create a full, factual, concise attendee brief with citations.\nThe meeting organiser is Lee Curtis from Legal engine, linkedin profile  here - https://www.linkedin.com/in/leeacurtis/.\n\nRules:\n- Disambiguate the person first. If uncertain, return top 3 candidates with confidence scores.\n- Base facts on public, professional sources only. No contact details or sensitive personal data.\n- Use UK English.\n- Output JSON ONLY that matches the schema in the user message.\n\n\nUse UK English. Today is {{$now.setZone('Europe/London').toFormat('yyyy-LL-dd')}}.",
              "role": "system"
            },
            {
              "content": "=Build an attendee brief.\n\nInputs:\n- Name: \"{{$json.name}}\"\n- Email: \"{{ $json.email }}\n- Company Domain (if known): \" {{ $json.domain }}\"\n- Role (if known):\n- Location (if relevant/if known):\n- Time horizon for \"recent\": last 60 months.\n\n\nDeliverable (JSON only):\n{\n  \"disambiguation\": {\n    \"matched_full_name\": \"\",\n    \"confidence\": 0.0,\n    \"alternates\": [\n      {\"name\": \"\", \"why_considered\": \"\", \"confidence\": 0.0}\n    ]\n  },\n  \"profile\": {\n    \"current_role\": \"\",\n    \"company\": \"\",\n    \"one_line_bio\": \"\",\n    \"3_talking_points\": [\"\" , \"\" , \"\"],\n    \"recent_news\": [\n      {\"headline\": \"\", \"date\": \"\", \"source_title\": \"\", \"source_url\": \"\"}\n    ],\n    \"career_highlights\": [\"\"],\n    \"topics_of_interest\": [\"\"],\n    \"potential_red_flags\": [\"\"]\n  },\n  \"sources_note\": \"Populate source_title/source_url ONLY from search_results metadata.\",\n  \"needs_review\": false\n}\n\nInstructions:\n- Keep \"one_line_bio\" ‚â§ 200 chars.\n- \"recent_news\" items must be within last 12 months.\n- If identity is ambiguous OR conflicting facts appear, set \"needs_review\": true and include up to 3 candidate profiles.\n"
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.perplexityTool",
      "typeVersion": 1,
      "position": [
        1600,
        -160
      ],
      "id": "84efac57-9eca-4c60-8035-42f53d967d22",
      "name": "Perplexity Search",
      "credentials": {
        "perplexityApi": {
          "id": "pOqM7kFIqiYB3qGU",
          "name": "Perplexity account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Normalize bios from ‚ÄúResearch Attendee (Agent)‚Äù\n// Works even if each item only has { output: \"<bio text>\" }.\n// If you also connect Input 1 with ‚ÄúSlim Inputs for Agent‚Äù (items with {name,email,domain}),\n// this node will align by index and/or fuzzy name to fill missing emails.\n//\n// Output (one per person):\n//   { emailLower?, email?, name?, domain?, bio, nameKey? }\n//\n// You can merge later by `emailLower` (preferred) and fall back to `nameKey` if email is missing.\n\nfunction clean(s){ return typeof s === 'string' ? s.trim() : ''; }\nfunction lower(s){ return typeof s === 'string' ? s.toLowerCase() : ''; }\n\n// --- regex helpers ---\nvar EMAIL_RE = /[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}/ig;\nvar HOST_RE  = /\\b((?:[a-z0-9-]+\\.)+[a-z]{2,})\\b/ig;\n\n// strip ``` fences and collapse whitespace a bit\nfunction normalizeText(t){\n  var txt = String(t == null ? '' : t);\n  if (txt.indexOf('```') > -1) {\n    txt = txt.replace(/```json/ig,'').replace(/```/g,'');\n  }\n  // trim line ends, collapse >2 newlines to 2\n  txt = txt.split('\\n').map(function(l){ return l.replace(/\\s+$/,''); }).join('\\n');\n  txt = txt.replace(/\\n{3,}/g, '\\n\\n');\n  return txt.trim();\n}\n\n// naive name guess: take leading fragment before \" is \" or first line\nfunction guessNameFromBio(txt){\n  var t = clean(txt);\n  if (!t) return '';\n  var firstLine = t.split('\\n')[0];\n  var beforeIs = firstLine.toString().split(/\\s+is\\s+/i)[0];\n  var cand = clean(beforeIs.length >= 3 ? beforeIs : firstLine);\n  // Keep it reasonable: 2‚Äì5 words, title-case-ish\n  var words = cand.split(/\\s+/).filter(Boolean);\n  if (words.length > 6) words = words.slice(0,6);\n  // If it's something like \"Founder and director\", that's not a name; reject if no capital letter start\n  var hasCap = /^[A-Z]/.test(words[0] || '');\n  return hasCap ? words.join(' ') : '';\n}\n\nfunction extractEmailFromText(txt){\n  var m = String(txt||'').match(EMAIL_RE);\n  return (m && m.length) ? m[0] : '';\n}\n\nfunction extractDomainFromText(txt){\n  // pick a plausible company domain; ignore common service hosts\n  var IGNORE = { 'www.google.com':1,'linkedin.com':1,'www.linkedin.com':1,'twitter.com':1,'x.com':1,'facebook.com':1,'instagram.com':1,'youtube.com':1,'outlook.office365.com':1,'microsoft.com':1,'github.com':1,'medium.com':1 };\n  var hosts = []; var h;\n  var text = String(txt||'');\n  while ((h = HOST_RE.exec(text)) !== null){\n    var host = h[1].toLowerCase();\n    if (!IGNORE[host]) hosts.push(host);\n  }\n  // Return the most frequent non-ignored host if any\n  if (hosts.length === 0) return '';\n  var freq = {}; var best = '', bestN = -1;\n  for (var i=0;i<hosts.length;i++){ var k=hosts[i]; freq[k]=(freq[k]||0)+1; if (freq[k]>bestN){ bestN=freq[k]; best=k; } }\n  return best;\n}\n\nfunction domainFromEmail(email){\n  var e = lower(clean(email)); var at = e.indexOf('@'); return at>-1 ? e.slice(at+1) : '';\n}\n\n// --- collect inputs ---\nvar outItems = ($input.all(0) || []).map(function(i){ return i.json; });\nvar hintItems = []; try { hintItems = ($input.all(1) || []).map(function(i){ return i.json; }); } catch(_){}\n\n// Build hint maps (by index, by lower(name), by lower(email))\nvar hintsByIndex = hintItems;\nvar hintsByName  = {};\nvar hintsByEmail = {};\nfor (var hi=0; hi<hintItems.length; hi++){\n  var h = hintItems[hi] || {};\n  var hEmail = clean(h.email || (h.emailAddress && h.emailAddress.address) || '');\n  var hName  = clean(h.name || h.person || h.fullName || h.attendeeName || '');\n  if (hName) hintsByName[lower(hName)] = h;\n  if (hEmail) hintsByEmail[lower(hEmail)] = h;\n}\n\n// Process each research output\nvar results = [];\n\nfor (var i=0; i<outItems.length; i++){\n  var row = outItems[i] || {};\n  var bioRaw = (row.bio !== undefined ? row.bio : (row.output !== undefined ? row.output : (row.text !== undefined ? row.text : row.content)));\n  var bio = normalizeText(bioRaw);\n\n  // Try to resolve identity\n  var email = extractEmailFromText(bio);\n  var name  = '';\n  var domain = '';\n\n  // If no email in text, try to align with hints\n  if (!email && hintsByIndex[i]){\n    var h = hintsByIndex[i];\n    var hEmail = clean(h.email || (h.emailAddress && h.emailAddress.address) || '');\n    if (hEmail) email = hEmail;\n    name = clean(h.name || h.person || h.fullName || h.attendeeName || '');\n    domain = clean(h.domain || '');\n  }\n\n  // If still no email, try name-match from text ‚Üí hintsByName\n  if (!email){\n    var guessName = guessNameFromBio(bio);\n    if (guessName && hintsByName[lower(guessName)]){\n      var hh = hintsByName[lower(guessName)];\n      email = clean(hh.email || (hh.emailAddress && hh.emailAddress.address) || '');\n      if (!name) name = clean(hh.name || hh.person || hh.fullName || hh.attendeeName || guessName);\n      if (!domain) domain = clean(hh.domain || '');\n    } else if (guessName) {\n      name = name || guessName;\n    }\n  }\n\n  // Derive domain if still missing\n  if (!domain){\n    if (email) domain = domainFromEmail(email);\n    if (!domain){\n      var dTxt = extractDomainFromText(bio);\n      if (dTxt) domain = dTxt;\n    }\n  }\n\n  // Fallback name if still empty\n  if (!name) name = guessNameFromBio(bio);\n\n  var emailLower = lower(email);\n  var nameKey = lower(clean(name));\n\n  results.push({\n    emailLower: emailLower || '',\n    email: email || '',\n    name: name || '',\n    domain: domain || '',\n    nameKey: nameKey || '',\n    bio: bio\n  });\n}\n\n// Deduplicate by emailLower if available; else by nameKey\nvar bestByKey = {};\nfor (var r=0; r<results.length; r++){\n  var it = results[r];\n  var key = it.emailLower || ('name:' + it.nameKey);\n  if (!key) continue;\n  var prev = bestByKey[key];\n  if (!prev || it.bio.length > prev.bio.length){\n    bestByKey[key] = it;\n    // prefer real email if one version had none\n    if (prev && !prev.email && it.email) bestByKey[key].email = it.email;\n    if (prev && !prev.domain && it.domain) bestByKey[key].domain = it.domain;\n  } else {\n    // keep better name if longer\n    if (it.name && (!prev.name || it.name.length > prev.name.length)) bestByKey[key].name = it.name;\n    if (it.domain && !prev.domain) bestByKey[key].domain = it.domain;\n    if (it.email && !prev.email) bestByKey[key].email = it.email;\n  }\n}\n\n// Emit items\nvar out = [];\nfor (var k in bestByKey){\n  out.push({ json: bestByKey[k] });\n}\n\nif (out.length === 0){\n  // Emit diagnostics to help wire Input 1 properly\n  return [{\n    json: {\n      warning: \"No usable bios (no email/name could be resolved). Consider connecting Slim Inputs as Input 1.\",\n      sampleKeys: Object.keys(outItems[0] || {}),\n      note: \"If Agent output only has 'output' text, merge with Slim Inputs by index so we can attach emails.\"\n    }\n  }];\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1808,
        -384
      ],
      "id": "5f15a0b2-1a43-4174-a976-ff58c293cbd0",
      "name": "Normalize Bios"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": false
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2032,
        -480
      ],
      "id": "e54f9349-90a4-4c19-9542-1dedfe3e3c23",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Grouped-by-meeting attendee summary\n// Output: ONE item per meeting with ALL attendees + details.\n// For each meeting you get:\n// {\n//   meetingId, meetingSubject, startISO, endISO, timeZone,\n//   bodyPreview, jobTitles (from body),\n//   attendees: [\n//     { name, email, domain, company, type, response, respondedAt }\n//   ]\n// }\n//\n// Input: one item per Outlook event (like the sample you posted)\n\nfunction clean(s){ return typeof s === 'string' ? s.trim() : ''; }\nfunction lower(s){ return typeof s === 'string' ? s.toLowerCase() : ''; }\nfunction get(o, path, d){\n  var parts = path.split('.'); var cur = o;\n  for (var i=0;i<parts.length;i++){ var k=parts[i]; if (cur && typeof cur==='object' && (k in cur)) cur = cur[k]; else return d; }\n  return cur;\n}\nfunction domainFromEmail(email){\n  var e = lower(clean(email)); var at = e.indexOf('@'); return at>-1 ? e.slice(at+1) : '';\n}\nfunction normalizeIso(s){\n  s = clean(s); if (!s) return null;\n  var t = s.replace(/Z$/,''); var dot = t.indexOf('.');\n  if (dot>-1) t = t.slice(0,dot);\n  if (t.length>=19) t = t.slice(0,19); // YYYY-MM-DDTHH:MM:SS\n  return t;\n}\nfunction isoFromEpochSec(sec){\n  if (typeof sec !== 'number') return null;\n  var d = new Date(sec*1000);\n  var yyyy = d.getUTCFullYear();\n  var mm = String(d.getUTCMonth()+1).padStart(2,'0');\n  var dd = String(d.getUTCDate()).padStart(2,'0');\n  var hh = String(d.getUTCHours()).padStart(2,'0');\n  var mi = String(d.getUTCMinutes()).padStart(2,'0');\n  var ss = String(d.getUTCSeconds()).padStart(2,'0');\n  return yyyy+'-'+mm+'-'+dd+'T'+hh+':'+mi+':'+ss;\n}\nfunction startISO(ev){\n  var s1 = get(ev,'start.dateTime', null); if (s1) return normalizeIso(String(s1));\n  var s2 = ev.startISO || get(ev,'start', null); if (typeof s2 === 'string') return normalizeIso(s2);\n  var e  = (typeof ev.epoch === 'number') ? ev.epoch : get(ev,'start.epoch', null);\n  if (typeof e === 'number') return normalizeIso(isoFromEpochSec(e));\n  return null;\n}\nfunction endISO(ev){\n  var e1 = get(ev,'end.dateTime', null); if (e1) return normalizeIso(String(e1));\n  var e2 = ev.endISO || get(ev,'end', null); if (typeof e2 === 'string') return normalizeIso(e2);\n  var ee = get(ev,'end.epoch', null);\n  if (typeof ee === 'number') return normalizeIso(isoFromEpochSec(ee));\n  return null;\n}\n\n// Infer a human-friendly company name from a domain (best-effort)\nfunction titleCase(s){\n  return s.split(/\\s+/).filter(Boolean).map(function(w){\n    return w.charAt(0).toUpperCase() + w.slice(1);\n  }).join(' ');\n}\nfunction inferCompanyFromDomain(domain){\n  domain = lower(clean(domain || ''));\n  if (!domain) return '';\n  var IGNORE = {\n    'gmail.com':1,'googlemail.com':1,'yahoo.com':1,'hotmail.com':1,'outlook.com':1,'live.com':1,\n    'msn.com':1,'icloud.com':1,'me.com':1,'proton.me':1,'protonmail.com':1,'gmx.com':1,'aol.com':1\n  };\n  if (IGNORE[domain]) return '';\n  var d = domain.replace(/^(mail|owa|webmail|mx|smtp|imap|app|portal|m|eu|us)\\./, '');\n  var multiTLDs = ['co.uk','com.au','com.br','com.ar','com.mx','co.jp','co.in','com.sg','com.hk','com.tr','com.cn','co.nz'];\n  for (var i=0;i<multiTLDs.length;i++){\n    var tld = multiTLDs[i];\n    if (d.endsWith('.' + tld)){\n      var base = d.slice(0, -(tld.length + 1));\n      var parts = base.split('.');\n      var label = parts[parts.length - 1] || base;\n      return titleCase(label.replace(/-/g,' '));\n    }\n  }\n  var parts2 = d.split('.');\n  if (parts2.length >= 2){\n    var core = parts2[parts2.length - 2];\n    return titleCase(core.replace(/-/g,' '));\n  }\n  return titleCase(d.replace(/-/g,' '));\n}\n\n// Extract likely job titles from the body preview\nfunction extractJobTitles(text){\n  var t = ' ' + clean(text) + ' ';\n  if (!t) return [];\n  var pats = [\n    /\\bChief\\s+[A-Za-z&\\- ]{2,30}\\b/gi,\n    /\\b(CFO|CEO|COO|CTO|CIO|CMO|CPO|CISO|GC)\\b/gi,\n    /\\b(SVP|EVP|VP|Assoc\\.?\\s?VP|Vice\\s+President)\\b/gi,\n    /\\bManaging\\s+Director\\b/gi,\n    /\\bDirector(?:\\s+of\\s+[A-Za-z&\\- ]{2,40})?\\b/gi,\n    /\\bHead\\s+of\\s+[A-Za-z&\\- ]{2,40}\\b/gi,\n    /\\bGlobal\\s+Head\\s+of\\s+[A-Za-z&\\- ]{2,40}\\b/gi,\n    /\\bPartner\\b/gi,\n    /\\b(Associate\\s+Director|Senior\\s+Manager|Manager)\\b/gi,\n    /\\b(Consultant|Principal)\\b/gi,\n    /\\b(General\\s+Counsel|Legal\\s+Counsel|Counsel|Attorney|Solicitor|Barrister)\\b/gi,\n    /\\b(Product|Engineering|Sales|Marketing|Operations|Finance|HR|People|Data|Design)\\s+(Manager|Director|Lead|Head)\\b/gi,\n    /\\b(Account\\s+Executive|Business\\s+Development|Recruiter)\\b/gi\n  ];\n  var found = [];\n  for (var i=0;i<pats.length;i++){\n    var re = pats[i], m;\n    while ((m = re.exec(t)) !== null){\n      var val = clean(m[0]);\n      if (val && found.indexOf(val) === -1) found.push(val);\n    }\n  }\n  return found;\n}\n\n// ------------- main -------------\nvar items = $input.all().map(function(i){ return i.json || {}; });\nvar out = [];\n\nfor (var i=0;i<items.length;i++){\n  var ev = items[i] || {};\n\n  var meetingId = ev.id || ev.eventId || null;\n  var subject = clean(ev.subject || ev.Subject || '(No subject)');\n  var bodyPreview = clean(ev.description || ev.bodyPreview || '');\n  var jobTitles = extractJobTitles(bodyPreview);\n\n  var sISO = startISO(ev);\n  var eISO = endISO(ev);\n  var tz = get(ev,'start.timeZone', get(ev,'time.timeZone', get(ev,'end.timeZone','UTC')));\n\n  var attendeesRaw = Array.isArray(ev.attendees) ? ev.attendees : [];\n  var attendees = [];\n  for (var a=0; a<attendeesRaw.length; a++){\n    var att = attendeesRaw[a] || {};\n    var email = clean(att.email || get(att,'emailAddress.address',''));\n    var name  = clean(att.name || get(att,'emailAddress.name','') || (email ? email.split('@')[0] : ''));\n    var domain = domainFromEmail(email);\n    var company = inferCompanyFromDomain(domain);\n    var type = clean(att.type || '');\n    var response = clean(att.response || get(att,'status.response','') || '');\n    var respondedAt = clean(att.respondedAt || get(att,'status.time','') || '');\n\n    // keep row even if name missing but email present\n    if (!name && !email) continue;\n\n    attendees.push({\n      name: name,\n      email: email,\n      domain: domain,\n      company: company,\n      type: type,\n      response: response,\n      respondedAt: respondedAt\n    });\n  }\n\n  // sort attendees by name then email for tidy output\n  attendees.sort(function(a,b){\n    var n = (a.name||'').localeCompare(b.name||''); return n!==0 ? n : (a.email||'').localeCompare(b.email||'');\n  });\n\n  out.push({\n    json: {\n      meetingId: meetingId,\n      meetingSubject: subject,\n      startISO: sISO,\n      endISO: eISO,\n      timeZone: tz,\n      bodyPreview: bodyPreview,\n      jobTitles: jobTitles,\n      attendees: attendees\n    }\n  });\n}\n\nreturn out.length ? out : [{ json: { warning: 'No meetings found in input' } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        -480
      ],
      "id": "74f1f2e6-c18f-465f-975e-7c7260cdaa89",
      "name": "Clean Calendar Data"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-mini-2025-08-07",
          "mode": "list",
          "cachedResultName": "gpt-5-mini-2025-08-07"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2336,
        -256
      ],
      "id": "2d33dde4-4306-4f6e-8395-ea3e7d1578d6",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "LldOhLNBReShSMkE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Clean Calendar Data ‚Üí AI-ready payloads (per meeting)\n// Input: items from your ‚ÄúClean Calendar Data‚Äù node. Handles both shapes:\n//   A) flat:  { subject, description, isAllDay, startISO, endISO, epoch?, end:{epoch?}, timeZone?, durationMinutes?, organizer{name,email}, attendees[], attendeesAll[], location{name}, meetingLink, webLink, internalDomain? }\n//   B) nested: { time:{ startISO, endISO, timeZone, durationMinutes }, organizer:{...}, attendeesAll:[...] }\n// Output (per meeting): { ai_event:{...minimal structured JSON...}, ai_text: \"...concise briefing...\" }\n//\n// Notes:\n// - No optional chaining / Intl; friendly to n8n cloud.\n// - Dedupes attendees, splits internal/external, strips noise, truncates long fields.\n\n//////////////////// helpers ////////////////////\nfunction clean(s){ return typeof s === 'string' ? s.trim() : ''; }\nfunction lower(s){ return typeof s === 'string' ? s.toLowerCase() : ''; }\nfunction get(o, p, d){\n  var parts = p.split('.'); var cur = o;\n  for (var i=0;i<parts.length;i++){ var k=parts[i]; if (cur && typeof cur==='object' && (k in cur)) cur = cur[k]; else return d; }\n  return cur;\n}\nfunction domainFromEmail(email){ var e = lower(clean(email)); var i = e.indexOf('@'); return i>-1 ? e.slice(i+1) : ''; }\nfunction normalizeIso(s){\n  s = clean(s); if (!s) return null;\n  var t = s.replace(/Z$/,''); var dot = t.indexOf('.');\n  if (dot>-1) t = t.slice(0, dot);\n  if (t.length>=19) t = t.slice(0,19); // YYYY-MM-DDTHH:MM:SS\n  return t;\n}\nfunction isoFromEpochSec(sec){\n  if (typeof sec !== 'number') return null;\n  var d = new Date(sec*1000);\n  var yyyy=d.getUTCFullYear(), mm=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0');\n  var hh=String(d.getUTCSeconds()>=30?d.getUTCHours()+Math.floor((d.getUTCMinutes()+1)/60):d.getUTCHours()).padStart(2,'0'); // minor guard\n  var mi=String(d.getUTCMinutes()).padStart(2,'0'); var ss='00';\n  return yyyy+'-'+mm+'-'+dd+'T'+hh+':'+mi+':'+ss;\n}\nfunction hhmm(iso){ return (iso && iso.length>=16) ? iso.slice(11,16) : ''; }\nfunction firstLine(s){ var t = clean(s); var i = t.indexOf('\\n'); return i>-1 ? t.slice(0,i) : t; }\nfunction clipWords(text, maxWords){\n  var ws = clean(text).split(/\\s+/).filter(Boolean);\n  if (ws.length <= maxWords) return ws.join(' ');\n  return ws.slice(0, maxWords).join(' ') + '‚Ä¶';\n}\nfunction prune(obj){\n  if (!obj || typeof obj!=='object') return obj;\n  var out = Array.isArray(obj) ? [] : {};\n  if (Array.isArray(obj)){\n    for (var i=0;i<obj.length;i++){\n      var v = prune(obj[i]);\n      var empty = v==='' || v==null || (typeof v==='object' && Object.keys(v).length===0);\n      if (!empty) out.push(v);\n    }\n  } else {\n    for (var k in obj){\n      var v2 = prune(obj[k]);\n      var empty2 = v2==='' || v2==null || (Array.isArray(v2) && v2.length===0) || (typeof v2==='object' && Object.keys(v2).length===0);\n      if (!empty2) out[k]=v2;\n    }\n  }\n  return out;\n}\nfunction uniqBy(arr, keyFn){\n  var seen = {}; var out = [];\n  for (var i=0;i<arr.length;i++){\n    var k = keyFn(arr[i]);\n    if (k && !seen[k]){ seen[k]=1; out.push(arr[i]); }\n    if (!k) out.push(arr[i]);\n  }\n  return out;\n}\nfunction normAttendee(a){\n  a = a || {};\n  var email = clean(a.email || get(a,'emailAddress.address',''));\n  var name  = clean(a.name  || get(a,'emailAddress.name','') || (email ? email.split('@')[0] : ''));\n  var type  = a.type || 'required';\n  var response = a.response || get(a,'status.response','none') || 'none';\n  var respondedAt = a.respondedAt || get(a,'status.time', null);\n  var domain = domainFromEmail(email);\n  var bio = clean(a.bio || a.output || '');\n  return { name: name, email: email, domain: domain, type: type, response: response, respondedAt: respondedAt, bio: bio };\n}\nfunction deriveTimes(ev){\n  var startISO = normalizeIso(get(ev,'time.startISO', null) || get(ev,'start.dateTime', null) || ev.startISO || (typeof ev.start === 'string' ? ev.start : null) || (typeof ev.epoch==='number' ? isoFromEpochSec(ev.epoch) : null) || (typeof get(ev,'start.epoch',null)==='number' ? isoFromEpochSec(get(ev,'start.epoch',null)) : null));\n  var endISO   = normalizeIso(get(ev,'time.endISO',   null) || get(ev,'end.dateTime',   null) || ev.endISO   || (typeof ev.end === 'string' ? ev.end : null)   || (typeof get(ev,'end.epoch',null)==='number' ? isoFromEpochSec(get(ev,'end.epoch',null)) : null));\n  var tz = get(ev,'time.timeZone', get(ev,'start.timeZone', get(ev,'end.timeZone','UTC')));\n  var display = ev.isAllDay ? 'All day' : (hhmm(startISO) + ((startISO && endISO)?'-':'') + hhmm(endISO));\n  var startEpoch = (typeof ev.epoch==='number') ? ev.epoch : get(ev,'time.startEpoch', get(ev,'start.epoch', null));\n  var endEpoch   = get(ev,'time.endEpoch', get(ev,'end.epoch', null));\n  var duration   = get(ev,'time.durationMinutes', ev.durationMinutes || null);\n  return { startISO:startISO, endISO:endISO, timeZone: tz, display: display, startEpoch: startEpoch, endEpoch: endEpoch, durationMinutes: duration };\n}\nfunction splitAttendees(list, internalDomain){\n  var intern = [], extern = [];\n  for (var i=0;i<list.length;i++){\n    var a = list[i];\n    if (a.domain && internalDomain && a.domain.toLowerCase()===internalDomain.toLowerCase()) intern.push(a);\n    else extern.push(a);\n  }\n  return {internal: intern, external: extern};\n}\nfunction isNoiseAttendee(a){\n  var e = lower(a.email||''); var n = lower(a.name||''); var t = lower(a.type||'');\n  return t==='resource' || n.indexOf('room')>-1 || e.indexOf('resource')>-1 || e.indexOf('calendar')>-1 || e.indexOf('no-reply')===0 || e.indexOf('noreply')===0;\n}\n\n//////////////////// main ////////////////////\nvar items = $input.all().map(function(i){ return i.json || {}; });\nvar out = [];\n\nfor (var i=0;i<items.length;i++){\n  var ev = items[i] || {};\n  var times = deriveTimes(ev);\n\n  var organizer = {\n    name: clean(get(ev,'organizer.name','')),\n    email: clean(get(ev,'organizer.email',''))\n  };\n  var internalDomain = clean(ev.internalDomain || domainFromEmail(organizer.email));\n\n  // Collect attendees from either attendeesAll (preferred) or attendees\n  var rawA = Array.isArray(ev.attendeesAll) ? ev.attendeesAll : (Array.isArray(ev.attendees) ? ev.attendees : []);\n  var att = rawA.map(normAttendee).filter(function(a){ return a.email || a.name; }).filter(function(a){ return !isNoiseAttendee(a); });\n  att = uniqBy(att, function(a){ return lower(a.email); });\n\n  var split = splitAttendees(att, internalDomain);\n\n  // Trim description, use first line as hint\n  var desc = clean(ev.description || ev.bodyPreview || '');\n  var descLine = firstLine(desc);\n  var descTrim = clipWords(desc, 90); // ~90 words max for hint\n\n  var subject = clean(ev.subject || ev.Subject || '(No subject)');\n  var dateISO = times.startISO ? times.startISO.slice(0,10) : null;\n\n  var externalBios = (Array.isArray(ev.externalAttendeeBios) ? ev.externalAttendeeBios : [])\n    .map(function(b){\n      return { name: clean(b.name||''), email: clean(b.email||''), domain: clean(b.domain||''), bio: clipWords(clean(b.bio||''), 120) };\n    });\n\n  var ai_event = prune({\n    id: ev.id || ev.eventId || null,\n    subject: subject,\n    isAllDay: !!ev.isAllDay,\n    date: dateISO,\n    time: {\n      startISO: times.startISO,\n      endISO: times.endISO,\n      timeZone: times.timeZone,\n      display: times.display,\n      startEpoch: times.startEpoch,\n      endEpoch: times.endEpoch,\n      durationMinutes: times.durationMinutes\n    },\n    organizer: organizer,\n    location: (get(ev,'location.name', null) || (typeof ev.location==='string' ? ev.location : null)) || null,\n    meetingLink: ev.meetingLink || null,\n    webLink: ev.webLink || null,\n    contextHint: descTrim || null,\n    attendees: {\n      internal: split.internal.map(function(a){ return { name:a.name, email:a.email, domain:a.domain, response:a.response }; }),\n      external: split.external.map(function(a){ return { name:a.name, email:a.email, domain:a.domain, response:a.response, bio: a.bio ? clipWords(a.bio, 120) : undefined }; })\n    },\n    externalBios: externalBios.length ? externalBios : undefined\n  });\n\n  // Compact text prompt for LLMs that prefer plain text\n  var ai_text = [\n    'Meeting: ' + subject,\n    'Date: ' + (dateISO || 'N/A') + '  Time: ' + (times.display || 'N/A') + ' ' + (times.timeZone || 'UTC'),\n    organizer.name || organizer.email ? ('Organizer: ' + clean([organizer.name, organizer.email ? '<'+organizer.email+'>' : ''].filter(Boolean).join(' '))) : null,\n    ev.location && (get(ev,'location.name',null) || typeof ev.location==='string') ? ('Location: ' + (get(ev,'location.name',null) || ev.location)) : null,\n    (ev.meetingLink || ev.webLink) ? ('Links: ' + [ev.meetingLink, ev.webLink].filter(Boolean).join(' | ')) : null,\n    split.internal.length ? ('Internal: ' + split.internal.map(function(a){ return a.name || a.email; }).join(', ')) : null,\n    split.external.length ? ('External: ' + split.external.map(function(a){ return a.name || a.email; }).join(', ')) : null,\n    externalBios.length ? ('External bios:\\n- ' + externalBios.map(function(b){ return (b.name || b.email) + ' ‚Äî ' + b.bio; }).join('\\n- ')) : null,\n    descLine ? ('Context: ' + descLine) : null\n  ].filter(Boolean).join('\\n');\n\n  out.push({ json: { ai_event: ai_event, ai_text: ai_text } });\n}\n\nif (out.length === 0){\n  return [{ json: { warning: 'No calendar items to clean. Check upstream node output.' } }];\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        -576
      ],
      "id": "8691bcc6-1a08-4d5d-9861-504f2080dcc8",
      "name": "Normalise Calendar Info"
    },
    {
      "parameters": {
        "jsCode": "// One OUTPUT PER EXTERNAL ATTENDEE per meeting\n// For each meeting, emit one item per external person:\n// { meetingSubject, startISO, endISO, name, email, domain, company }\n//\n// Edit if needed:\nconst INTERNAL_DOMAINS = [\"legalengine.co.uk\"];\n\n// ---------- helpers ----------\nfunction clean(s){ return (typeof s === 'string' ? s.trim() : (s==null ? '' : String(s).trim())); }\nfunction lower(s){ return typeof s === 'string' ? s.toLowerCase() : ''; }\nfunction get(o, path, d){\n  var parts = path.split('.'); var cur = o;\n  for (var i=0;i<parts.length;i++){ var k=parts[i]; if (cur && typeof cur==='object' && (k in cur)) cur = cur[k]; else return d; }\n  return cur;\n}\nfunction domainFromEmail(email){ var e = lower(clean(email)); var i = e.indexOf('@'); return i>-1 ? e.slice(i+1) : ''; }\nfunction isoFromEpochSec(sec){\n  if (typeof sec !== 'number') return null;\n  var d=new Date(sec*1000), yyyy=d.getUTCFullYear(), mm=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0'),\n      hh=String(d.getUTCHours()).padStart(2,'0'), mi=String(d.getUTCMinutes()).padStart(2,'0'), ss=String(d.getUTCSeconds()).padStart(2,'0');\n  return `${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}`;\n}\nfunction normalizeIso(s){\n  s = clean(s); if (!s) return null;\n  var t = s.replace(/Z$/,''); var dot = t.indexOf('.');\n  if (dot>-1) t = t.slice(0,dot);\n  if (t.length>=19) t = t.slice(0,19); // YYYY-MM-DDTHH:MM:SS\n  return t;\n}\nfunction startISOFromEvent(ev){\n  var s1 = get(ev,'start.dateTime',null); if (s1) return normalizeIso(String(s1));\n  var s2 = ev.startISO || get(ev,'start',null); if (typeof s2 === 'string') return normalizeIso(s2);\n  var e  = (typeof ev.epoch === 'number') ? ev.epoch : get(ev,'start.epoch',null);\n  if (typeof e === 'number') return normalizeIso(isoFromEpochSec(e));\n  return null;\n}\nfunction endISOFromEvent(ev){\n  var e1 = get(ev,'end.dateTime',null); if (e1) return normalizeIso(String(e1));\n  var e2 = ev.endISO || get(ev,'end',null); if (typeof e2 === 'string') return normalizeIso(e2);\n  var ee = get(ev,'end.epoch',null);\n  if (typeof ee === 'number') return normalizeIso(isoFromEpochSec(ee));\n  return null;\n}\nfunction titleCase(s){ return String(s||'').split(/\\s+|-/).filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }\nfunction inferCompanyFromDomain(domain){\n  domain = lower(clean(domain||'')); if (!domain) return '';\n  const IGNORE={'gmail.com':1,'googlemail.com':1,'yahoo.com':1,'hotmail.com':1,'outlook.com':1,'live.com':1,'msn.com':1,'icloud.com':1,'me.com':1,'proton.me':1,'protonmail.com':1,'gmx.com':1,'aol.com':1};\n  if (IGNORE[domain]) return '';\n  var d = domain.replace(/^(mail|owa|webmail|mx|smtp|imap|app|portal|m|eu|us)\\./,'');\n  var multi=['co.uk','com.au','com.br','com.ar','com.mx','co.jp','co.in','com.sg','com.hk','com.tr','com.cn','co.nz'];\n  for (var i=0;i<multi.length;i++){ var t=multi[i]; if (d.endsWith('.'+t)){ var base=d.slice(0,-(t.length+1)); var p=base.split('.'); return titleCase(p[p.length-1]||base); } }\n  var parts=d.split('.'); if (parts.length>=2) return titleCase(parts[parts.length-2]); return titleCase(d);\n}\nfunction isNoiseAttendee(nameLower, emailLower, typeLower){\n  return typeLower==='resource' || nameLower.indexOf('room')>-1 || emailLower.indexOf('resource')>-1 ||\n         emailLower.indexOf('calendar')>-1 || emailLower.indexOf('no-reply')===0 || emailLower.indexOf('noreply')===0;\n}\nfunction getSubject(ev){\n  var candidates = ['meetingSubject','subject','Subject','title','name','summary'];\n  for (var i=0;i<candidates.length;i++){\n    var v = ev[candidates[i]];\n    if (typeof v === 'string' && clean(v)) return clean(v);\n  }\n  return '(No subject)';\n}\n\n// ---------- inputs & internal domain inference ----------\nvar events = $input.all().map(i=>i.json||{});\n\nvar counts={}; \nfor (var i=0;i<events.length;i++){\n  var org=clean(get(events[i],'organizer.email','')||get(events[i],'organizer.emailAddress.address',''));\n  var d=domainFromEmail(org); if(d) counts[d]=(counts[d]||0)+1;\n}\nvar globalInternal=null,bestN=-1;\nfor (var k in counts){ if(counts[k]>bestN){ bestN=counts[k]; globalInternal=k; } }\nvar INTERNAL = new Set([].concat(INTERNAL_DOMAINS, globalInternal?[globalInternal]:[]).filter(Boolean).map(x=>lower(x)));\n\n// ---------- emit one item per external attendee per meeting ----------\nvar out = [];\n\nfor (var j=0;j<events.length;j++){\n  var ev = events[j] || {};\n  var subject = getSubject(ev);\n  var sISO = startISOFromEvent(ev);\n  var eISO = endISOFromEvent(ev);\n\n  var attendeesRaw = Array.isArray(ev.attendees) ? ev.attendees : [];\n  var seen = {}; // de-dupe by email within this meeting\n\n  for (var a=0;a<attendeesRaw.length;a++){\n    var att = attendeesRaw[a] || {};\n    var emailOrig = clean(att.email || get(att,'emailAddress.address',''));\n    var email = lower(emailOrig);\n    if (!email || email.indexOf('@')===-1) continue;\n\n    var name = clean(att.name || get(att,'emailAddress.name','') || (emailOrig?emailOrig.split('@')[0]:''));\n    var domain = domainFromEmail(emailOrig);\n    var typeLower = lower(String(att.type||'')); var nameLower = lower(name);\n\n    if (isNoiseAttendee(nameLower, email, typeLower)) continue;\n    if (INTERNAL.has(domain)) continue;\n    if (seen[email]) continue; seen[email]=1;\n\n    out.push({ json: {\n      meetingSubject: subject,\n      startISO: sISO,\n      endISO: eISO,\n      name: name,\n      email: emailOrig,\n      domain: domain,\n      company: inferCompanyFromDomain(domain)\n    }});\n  }\n}\n\n// Sort by meeting start time, then subject, then attendee name\nout.sort((a,b)=>{\n  const as=a.json.startISO||'', bs=b.json.startISO||'';\n  if (as!==bs) return as<bs?-1:1;\n  const ms=(a.json.meetingSubject||'').localeCompare(b.json.meetingSubject||'');\n  if (ms!==0) return ms;\n  return (a.json.name||'').localeCompare(b.json.name||'');\n});\n\nreturn out.length ? out : [{ json: { info: 'No external attendees found in input.' } }];\n"
      },
      "id": "f29f0d69-3108-447f-941c-199caeac6cf0",
      "name": "Extract External Attendees",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        -384
      ]
    },
    {
      "parameters": {
        "operation": "addToDate",
        "magnitude": "={{ $json.currentDate }}",
        "duration": 5,
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        112,
        -480
      ],
      "id": "ffafab3e-7dcf-461e-8c58-8a43edef0499",
      "name": "Tomorrow +2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You will receive information relating to one or more meetings, decide which information to use for each meeting and cycle through them one by one.\n\nOnly produce an output for meetings with external attendees {{ $('Extract External Attendees').item.json.email }}.\n\nMeeting Name:{{ $('Get many events').item.json.subject }}\nMeeting date and start time:{{ $('Get many events').item.json.start.dateTime }}\nAttendees:{{ $('Get many events').item.json.attendees[0].emailAddress.name }}, {{ $('Get many events').item.json.attendees[1].emailAddress.name }}, {{ $('Get many events').item.json.attendees[3].emailAddress.name }}, {{ $('Get many events').item.json.attendees[4].emailAddress.name }}, {{ $('Get many events').item.json.attendees[5].emailAddress.name }}, {{ $('Get many events').item.json.attendees[6].emailAddress.name }}, {{ $('Get many events').item.json.attendees[7].emailAddress.name }}, {{ $('Get many events').item.json.attendees[8].emailAddress.name }}, {{ $('Get many events').item.json.attendees[9].emailAddress.name }}, {{ $('Get many events').item.json.attendees[10].emailAddress.name }}\nBio for external attendeess:{{ $json.bio }}",
        "options": {
          "systemMessage": "You are an expert personal business assistant. For each calendar event, write me a full summary of the event with dates, times, attendees, meeting length and the external bios to allow attendees to prepare for the meetings taking place today.",
          "returnIntermediateSteps": false
        }
      },
      "id": "6ede82b0-ae15-44a8-b9c8-238143e4720e",
      "name": "Summary Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2256,
        -480
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-mini-2025-08-07",
          "mode": "list",
          "cachedResultName": "gpt-5-mini-2025-08-07"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2688,
        -656
      ],
      "id": "b60a75cb-2573-450a-8e93-d601f4194416",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "LldOhLNBReShSMkE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You will receive information relating to one or more meetings, decide which information to use for each meeting and cycle through them one by one.\n{{ $json.output }}\n",
        "options": {
          "systemMessage": "=You are an expert in creating html emails that format calendar details perfectly and create an easy to digest email template to brief a professional on what they have on that day  ",
          "returnIntermediateSteps": false
        }
      },
      "id": "6a86d7a9-2a24-4cfb-9909-40e6e053978c",
      "name": "HTML Creator",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        2608,
        -880
      ],
      "alwaysOutputData": true,
      "disabled": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2672,
        -288
      ],
      "id": "7205399f-111f-4632-bf16-7da763fb1c37",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "jsCode": "// Mode: Run once for all items\nconst items = $input.all().map(i => i.json);\n\n// Choose which field(s) to join\nconst lines = items.map(j =>\n  j.html || j.ai_text || j.text || j.output || j.name || JSON.stringify(j)\n).filter(Boolean);\n\n// Build one string\nconst text = lines.join('\\n\\n---\\n\\n');\n\n// Return ONE item with the string\nreturn [{ json: { text } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        -288
      ],
      "id": "c987685c-bcd2-4d97-9457-0b1ee137bd1f",
      "name": "Compiler"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -336,
        -384
      ],
      "id": "ebc4ff8f-e396-483d-ba3b-f22af6b1e2b0",
      "name": "When clicking ‚ÄòExecute workflow‚Äô"
    },
    {
      "parameters": {
        "path": "25dfcb31-345e-4b2b-bf4a-94489d014ad1",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -336,
        -736
      ],
      "id": "d28f7af7-f8b6-41c1-9c21-4594e934ce5c",
      "name": "Webhook",
      "webhookId": "25dfcb31-345e-4b2b-bf4a-94489d014ad1",
      "disabled": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "L7d862M6TNb5DkV6",
          "mode": "list",
          "cachedResultName": "DEV - S2 - Create KB & Agent"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3584,
        -288
      ],
      "id": "de13f857-2ef5-4c62-a804-bb6b0f01d83b",
      "name": "Execute Workflow"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a7518b23-e670-4c5b-b688-be09a1e6a1ec",
              "name": "text",
              "value": "={{ $('Compiler').item.json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3376,
        -288
      ],
      "id": "881b7ca1-7280-4451-9b3f-4bc14f5dd1d2",
      "name": "Set Nodes to pass"
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Today",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Today": {
      "main": [
        [
          {
            "node": "Tomorrow +2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF ‚Äî No meetings today?": {
      "main": [
        [
          {
            "node": "Extract External Attendees",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Research Attendee (Agent)": {
      "main": [
        [
          {
            "node": "Normalize Bios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Briefing": {
      "main": [
        [
          {
            "node": "Send Briefing (Outlook, HTML)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Briefing (Outlook, HTML)": {
      "main": [
        []
      ]
    },
    "Get many events": {
      "main": [
        [
          {
            "node": "Clean Calendar Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Research Attendee (Agent)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Perplexity Search": {
      "ai_tool": [
        [
          {
            "node": "Research Attendee (Agent)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Bios": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean Calendar Data": {
      "main": [
        [
          {
            "node": "IF ‚Äî No meetings today?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Normalise Calendar Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Summary Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Summary Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Normalise Calendar Info": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Extract External Attendees": {
      "main": [
        [
          {
            "node": "Research Attendee (Agent)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tomorrow +2": {
      "main": [
        [
          {
            "node": "Get many events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summary Agent": {
      "main": [
        [
          {
            "node": "Generate HTML Briefing",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTML Creator",
            "type": "main",
            "index": 0
          },
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "HTML Creator",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "HTML Creator": {
      "main": [
        [
          {
            "node": "Send Briefing (Outlook, HTML)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Compiler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compiler": {
      "main": [
        [
          {
            "node": "Set Nodes to pass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "Today",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Today",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Workflow": {
      "main": [
        []
      ]
    },
    "Set Nodes to pass": {
      "main": [
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 1,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}