{
  "name": "Fladgate History Webhook - Edu (Structured Response)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "history-structured",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "7bdb18d7-f41c-4176-8fd4-3c59345c8221",
      "name": "ElevenLabs Webhook1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -240,
        -96
      ],
      "webhookId": "e773693d-47ec-4b63-8243-83db41e06351"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appUvJyzSky12m4HA",
          "mode": "list",
          "cachedResultName": "Fladgate - Leonard Live Data",
          "cachedResultUrl": "https://airtable.com/appUvJyzSky12m4HA"
        },
        "table": {
          "__rl": true,
          "value": "tbl3ADT2yOV8EJCnZ",
          "mode": "list",
          "cachedResultName": "FG - Conversation History by lawyer",
          "cachedResultUrl": "https://airtable.com/appUvJyzSky12m4HA/tbl3ADT2yOV8EJCnZ"
        },
        "filterByFormula": "={Email}='{{ $json.body.email }}'",
        "options": {
          "fields": [
            "Email",
            "Transcript ID",
            "Full Name",
            "First Name",
            "Last Name",
            "Last Modified",
            "Conversation History",
            "Clients",
            "Matters",
            "Previous Matters",
            "Previous Clients",
            "Previous Submissions"
          ]
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        208,
        -96
      ],
      "id": "f5dbe43f-63d0-4e36-b1a9-cadec2e35565",
      "name": "Search records1",
      "alwaysOutputData": true,
      "credentials": {
        "airtableTokenApi": {
          "id": "LVF892xkQD72QD7v",
          "name": "Airtable - Leonard @ Legal Engine"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2247ff15-b8fe-43df-bb1d-f1663de23178",
              "name": "First Name",
              "value": "={{ $json[\"First Name\"] }}",
              "type": "string"
            },
            {
              "id": "ae71fb34-3630-429a-bf54-fbe6c654bd24",
              "name": "Last Name",
              "value": "={{ $json[\"Last Name\"] }}",
              "type": "string"
            },
            {
              "id": "4caf8e85-0a23-448c-a06e-131c6886edd1",
              "name": "Conversation history",
              "value": "={{ $json[\"Conversation History\"] }}",
              "type": "string"
            },
            {
              "id": "07cc8775-1b97-4d1b-a1e3-bcaa95a87028",
              "name": "Last Modified Time",
              "value": "={{ $json[\"Last Modified\"] }}",
              "type": "string"
            },
            {
              "id": "98344d5b-2a07-471b-b108-40b8b7e1c0f1",
              "name": "Clients",
              "value": "={{ $json.Clients }}",
              "type": "string"
            },
            {
              "id": "963ac931-4ce1-486e-b408-d6b6a55e15bd",
              "name": "Matters",
              "value": "={{ $json.Matters }}",
              "type": "string"
            },
            {
              "id": "e31bceac-2729-4c9a-830d-984ee0e7bd62",
              "name": "previous_matters",
              "value": "={{ $json[\"Previous Matters\"] }}",
              "type": "string"
            },
            {
              "id": "e01a2442-28be-4b90-af28-563c3e71be29",
              "name": "previous_clients",
              "value": "={{ $json[\"Previous Clients\"] }}",
              "type": "string"
            },
            {
              "id": "f3291926-e8c4-4b4e-af26-7b66b1889ee3",
              "name": "previous_submissions",
              "value": "={{ $json[\"Previous Submissions\"] }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": "={{ false }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        432,
        -96
      ],
      "id": "77173e8f-2d2f-47b6-b628-a8fc5c46f738",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7b023aea-7579-45d0-acdd-e3ac147f550b",
              "leftValue": "={{ $json.Clients }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        624,
        -96
      ],
      "id": "25634d2a-fd3b-4aea-9cc5-c1f5cc6beddd",
      "name": "If"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{\n  \"{\\n\" +\n  \"  \\\"conversation_history\\\": \" + JSON.stringify($json[\"Conversation history\"]) + \",\\n\" +\n  \"  \\\"clients\\\": \" + JSON.stringify($items('Search records1')[0]?.json?.Clients ?? \"no details found\") + \",\\n\" +\n  \"  \\\"matters\\\": \" + JSON.stringify($items('Search records1')[0]?.json?.Matters ?? \"no details found\") + \"\\n\" +\n  \"}\"\n}}\n",
        "options": {}
      },
      "id": "21f116ca-addd-40ad-908f-325c27219fef",
      "name": "Return 'no details' ElevenLabs",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        864,
        -64
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse conversation_history into structured array\n// Handles Airtable's JSON wrapper format: {\"state\":\"generated\",\"value\":\"...\",\"isStale\":false}\n// The value contains markdown-formatted matter entries separated by \", **NEW MATTER**,\"\n\nfunction extractMarkdownField(text, fieldName) {\n  // Match markdown list format: \"- Field: value\" or \"- Field: value (additional)\"\n  const regex = new RegExp(`- ${fieldName}:\\\\s*(.+?)(?:\\\\n|$)`, \"i\");\n  const match = text.match(regex);\n  return match ? match[1].trim() : null;\n}\n\nfunction extractMatterTitle(text) {\n  // Match markdown header: \"### Matter Title\" or \"### Confidential Matter X\"\n  const regex = /###\\s+(.+?)(?:\\n|$)/;\n  const match = text.match(regex);\n  return match ? match[1].trim() : null;\n}\n\n// Get raw data - might be string or object\nlet rawHistory = $json[\"Conversation history\"] || \"\";\nlet historyContent = \"\";\n\n// Handle JSON wrapper format\nif (typeof rawHistory === \"string\") {\n  try {\n    const parsed = JSON.parse(rawHistory);\n    if (parsed && parsed.value) {\n      historyContent = parsed.value;\n    } else {\n      historyContent = rawHistory;\n    }\n  } catch (e) {\n    // Not JSON, use as-is\n    historyContent = rawHistory;\n  }\n} else if (typeof rawHistory === \"object\" && rawHistory.value) {\n  historyContent = rawHistory.value;\n}\n\nconst matters = [];\n\n// Split by the **NEW MATTER** delimiter (with optional commas/whitespace)\nconst parts = historyContent.split(/,?\\s*\\*\\*NEW MATTER\\*\\*,?\\s*/);\n\nfor (const part of parts) {\n  if (!part.trim()) continue;\n\n  const matter = {\n    matter_name: extractMatterTitle(part),\n    matter_value: extractMarkdownField(part, \"Matter value\"),\n    client: extractMarkdownField(part, \"Client\"),\n    status: extractMarkdownField(part, \"Status\") || extractMarkdownField(part, \"Completion\"),\n    lead_lawyer: extractMarkdownField(part, \"Lead lawyer(?:s)?\"),\n    team: extractMarkdownField(part, \"Team\"),\n    other_firms: extractMarkdownField(part, \"Other firms/advisers\") || extractMarkdownField(part, \"Other firms and roles\"),\n    sector: extractMarkdownField(part, \"Sector(?:s)?\"),\n    project: extractMarkdownField(part, \"Project(?:s)?\"),\n    jurisdiction: extractMarkdownField(part, \"Jurisdiction\"),\n    cross_border: extractMarkdownField(part, \"Cross-border\")\n  };\n\n  // Only include if we found at least a matter name\n  if (matter.matter_name) {\n    matters.push(matter);\n  }\n}\n\n// Handle Clients field - also might have JSON wrapper\nlet clientsRaw = $json.Clients || \"\";\nlet clientsList = \"\";\nif (typeof clientsRaw === \"string\") {\n  try {\n    const parsed = JSON.parse(clientsRaw);\n    if (parsed && parsed.value) {\n      clientsList = parsed.value;\n    } else {\n      clientsList = clientsRaw;\n    }\n  } catch (e) {\n    clientsList = clientsRaw;\n  }\n} else if (typeof clientsRaw === \"object\" && clientsRaw.value) {\n  clientsList = clientsRaw.value;\n}\n\n// Return structured data\nreturn [{\n  json: {\n    matters: matters,\n    matter_count: matters.length,\n    clients: clientsList,\n    raw_history: historyContent\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        750,
        -240
      ],
      "id": "parse-matters-to-json",
      "name": "Parse Matters to JSON"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "1ab1c62a-e1e0-460b-9793-fb71036c4d84",
      "name": "Return Conv History to ElevenLabs",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        950,
        -240
      ]
    },
    {
      "parameters": {
        "jsCode": "// Helper to walk any object/array and lowercase all \"email\" fields\nfunction lowercaseEmails(obj) {\n  if (obj == null || typeof obj !== 'object') {\n    return;\n  }\n\n  if (Array.isArray(obj)) {\n    for (const el of obj) {\n      lowercaseEmails(el);\n    }\n    return;\n  }\n\n  for (const key of Object.keys(obj)) {\n    const value = obj[key];\n\n    // If the property name is \"email\" and it is a string. lowercase it\n    if (key === 'email' && typeof value === 'string') {\n      obj[key] = value.toLowerCase();\n    }\n\n    // Recurse into nested objects or arrays\n    if (value && typeof value === 'object') {\n      lowercaseEmails(value);\n    }\n  }\n}\n\nreturn items.map(item => {\n  // Clone json so we do not accidentally break references\n  const out = {\n    ...item,\n    json: { ...item.json },\n  };\n\n  // This will hit body.email in your sample payload. plus any other email fields anywhere\n  lowercaseEmails(out.json);\n\n  return out;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        -96
      ],
      "id": "5a05fae8-8264-40b2-91b5-9e152834d896",
      "name": "lowercase email"
    }
  ],
  "connections": {
    "ElevenLabs Webhook1": {
      "main": [
        [
          {
            "node": "lowercase email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search records1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Parse Matters to JSON",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return 'no details' ElevenLabs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Matters to JSON": {
      "main": [
        [
          {
            "node": "Return Conv History to ElevenLabs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "lowercase email": {
      "main": [
        [
          {
            "node": "Search records1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 1,
  "meta": null
}