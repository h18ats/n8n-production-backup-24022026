{
  "name": "LIVE - Lee Oz Webinar Attendee Search - Owner Andy",
  "nodes": [
    {
      "parameters": {},
      "id": "ae0012a3-ced0-4e86-a971-664d09cd6c85",
      "name": "When clicking Test workflow1",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1808,
        1264
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "9532c603-8820-4677-94e1-a7954492b476",
      "name": "Loop Over Emails",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -896,
        1264
      ]
    },
    {
      "parameters": {
        "jsCode": "const inputDate = new Date($input.first().json.currentDate); // replace with actual field name\n\nconst formattedDate = `${inputDate.getMonth() + 1}/${inputDate.getDate()}/${inputDate.getFullYear()}`;\n\nreturn [\n  {\n    json: {\n      formattedDate\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        1264
      ],
      "id": "121e45ca-d162-4f4f-a0b2-35c5f81a24b0",
      "name": "Date Format1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -1600,
        1264
      ],
      "id": "702c9859-0afd-4efd-8e0a-9569d93fafce",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appclnlBFOaFM6ZTW",
          "mode": "list",
          "cachedResultName": "Legal Engine Internal",
          "cachedResultUrl": "https://airtable.com/appclnlBFOaFM6ZTW"
        },
        "table": {
          "__rl": true,
          "value": "tblPNVxBXRgkMQ7hb",
          "mode": "list",
          "cachedResultName": "Imported table",
          "cachedResultUrl": "https://airtable.com/appclnlBFOaFM6ZTW/tblPNVxBXRgkMQ7hb"
        },
        "options": {},
        "sort": {
          "property": [
            {
              "field": "Email"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        -1200,
        1264
      ],
      "id": "598d9d50-634a-41d1-8d80-9ff183480116",
      "name": "Airtable Source",
      "credentials": {
        "airtableTokenApi": {
          "id": "LVF892xkQD72QD7v",
          "name": "Airtable - Leonard @ Legal Engine"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "69676b6c-2bf4-4312-b916-4316c66421a8",
              "leftValue": "={{ $json.error.message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -336,
        1008
      ],
      "id": "aad1a1a6-17a5-4a50-96c3-88a8db7b5f49",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "let content = $json.choices?.[0]?.message?.content ?? \"\";\n\n// Remove Markdown fences and trim\ncontent = content.replace(/```(?:json)?/g, \"\").trim();\n\nlet parsed;\ntry {\n  parsed = JSON.parse(content);\n} catch {\n  parsed = { message: \"No info found\" };\n}\n\n// Useful data check\nfunction hasUsefulData(obj) {\n  if (obj == null || obj === \"\" || (Array.isArray(obj) && obj.length === 0)) return false;\n  if (typeof obj === \"object\" && !Array.isArray(obj)) {\n    return Object.values(obj).some(v => hasUsefulData(v));\n  }\n  return true;\n}\nif (!hasUsefulData(parsed)) parsed = { message: \"No info found\" };\n\n// If array, take first\nif (Array.isArray(parsed)) parsed = parsed[0] ?? { message: \"No info found\" };\n\n// Deep flatten into dot paths and snake paths\nfunction toSnake(s) {\n  return s\n    .replace(/[^a-zA-Z0-9]+/g, \"_\")\n    .replace(/_+/g, \"_\")\n    .replace(/^_|_$/g, \"\")\n    .toLowerCase();\n}\n\nfunction flatten(obj, prefix = \"\", out = {}) {\n  if (obj == null) {\n    out[prefix] = obj;\n    return out;\n  }\n  if (typeof obj !== \"object\" || obj instanceof Date) {\n    if (prefix) out[prefix] = obj;\n    return out;\n  }\n  if (Array.isArray(obj)) {\n    // Represent arrays as JSON strings to keep primitives\n    if (prefix) out[prefix] = JSON.stringify(obj);\n    return out;\n  }\n  for (const [k, v] of Object.entries(obj)) {\n    const dotKey = prefix ? `${prefix}.${k}` : k;\n    flatten(v, dotKey, out);\n  }\n  return out;\n}\n\n// Coercion helpers\nfunction toISODateString(x) {\n  const d = new Date(x);\n  return isNaN(d.getTime()) ? null : d.toISOString().slice(0, 10);\n}\n\nfunction coercePrimitive(val) {\n  if (val == null) return \"\";\n  if (typeof val === \"string\") return val.trim();\n  if (typeof val === \"number\" || typeof val === \"boolean\") return val;\n  if (val instanceof Date) return toISODateString(val) ?? val.toISOString();\n  // objects and arrays become JSON\n  return JSON.stringify(val);\n}\n\n// Normalise known fields on the original object first\nif (parsed.lastUpdated != null) {\n  const iso = toISODateString(parsed.lastUpdated);\n  parsed.lastUpdated = iso ?? String(parsed.lastUpdated).trim();\n}\nif (parsed.website != null) {\n  let w = String(parsed.website).trim();\n  w = w.replace(/^https?:\\/\\//i, \"\").replace(/\\/+$/g, \"\");\n  parsed.website = w;\n}\n\n// Coerce all top-level props to primitives\nfor (const k of Object.keys(parsed)) {\n  parsed[k] = coercePrimitive(parsed[k]);\n}\n\n// Build flattened maps\nconst flatDot = flatten(parsed);\nconst flatSnake = {};\nfor (const [k, v] of Object.entries(flatDot)) {\n  flatSnake[toSnake(k)] = v;\n}\n\n// Coerce all flattened values to primitives\nfor (const k of Object.keys(flatDot)) {\n  flatDot[k] = coercePrimitive(flatDot[k]);\n}\nfor (const k of Object.keys(flatSnake)) {\n  flatSnake[k] = coercePrimitive(flatSnake[k]);\n}\n\n// Provide stable aliases for common merge keys\nconst aliases = {\n  fullName: parsed.fullName ?? flatDot[\"fullName\"] ?? \"\",\n  actualCompanyName: parsed.actualCompanyName ?? flatDot[\"actualCompanyName\"] ?? \"\",\n  website: parsed.website ?? flatDot[\"website\"] ?? \"\",\n  lastUpdated: parsed.lastUpdated ?? flatDot[\"lastUpdated\"] ?? \"\"\n};\n\n// Build a composite merge key\nconst __mergeKey = [aliases.fullName, aliases.actualCompanyName, aliases.website]\n  .map(x => String(x || \"\").toLowerCase().trim())\n  .join(\"|\");\n\n// Final payload\nconst out = {\n  ...parsed,\n  ...flatDot,\n  ...flatSnake,\n  ...aliases,\n  __mergeKey\n};\n\n// Ensure strings for all merge candidates\nfor (const k of [\"fullName\", \"actualCompanyName\", \"website\", \"lastUpdated\", \"__mergeKey\"]) {\n  if (k in out) out[k] = coercePrimitive(out[k]);\n}\n\n// De-duplicate keys case-insensitively\n// Keeps the first occurrence (from parsed), drops later duplicates (from flatSnake etc.)\nconst seenLower = new Set();\nfor (const key of Object.keys(out)) {\n  const lower = key.toLowerCase();\n  if (seenLower.has(lower)) {\n    delete out[key];\n  } else {\n    seenLower.add(lower);\n  }\n}\n\n// Return n8n-compatible single item\nreturn [\n  {\n    json: out\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        144,
        1008
      ],
      "id": "d5ad383a-6c77-4861-8d18-c47626e458fb",
      "name": "PP Flattening"
    },
    {
      "parameters": {
        "operation": "upsert",
        "base": {
          "__rl": true,
          "value": "appclnlBFOaFM6ZTW",
          "mode": "list",
          "cachedResultName": "Legal Engine Internal",
          "cachedResultUrl": "https://airtable.com/appclnlBFOaFM6ZTW"
        },
        "table": {
          "__rl": true,
          "value": "tblPNVxBXRgkMQ7hb",
          "mode": "list",
          "cachedResultName": "Imported table",
          "cachedResultUrl": "https://airtable.com/appclnlBFOaFM6ZTW/tblPNVxBXRgkMQ7hb"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Full Name": "={{ $json.fullName }}",
            "Name": "={{ $json.fullName }}",
            "Org": "={{ $json.organisation }}",
            "LinkedIN": "={{ $json.linkedin }}",
            "Location": "={{ $json.currentLocation }}",
            "Background": "={{ $json.background300Words }}",
            "Legal Tech Interest": "={{ $json.legalTechInterest50Words }}",
            "verification": "={{ $json.verification }}",
            "Role": "={{ $json.role }}"
          },
          "matchingColumns": [
            "Name"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Firm",
              "displayName": "Firm",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "options",
              "options": [
                {
                  "name": "MinterEllison",
                  "value": "MinterEllison"
                },
                {
                  "name": "Ashurst",
                  "value": "Ashurst"
                },
                {
                  "name": "Hall & Wilcox",
                  "value": "Hall & Wilcox"
                },
                {
                  "name": "Gilbert + Tobin",
                  "value": "Gilbert + Tobin"
                },
                {
                  "name": "KWM",
                  "value": "KWM"
                },
                {
                  "name": "Cowell Clarke",
                  "value": "Cowell Clarke"
                },
                {
                  "name": "HopgoodGanim",
                  "value": "HopgoodGanim"
                },
                {
                  "name": "Russell McVeagh",
                  "value": "Russell McVeagh"
                },
                {
                  "name": "Gilchrist Connell",
                  "value": "Gilchrist Connell"
                },
                {
                  "name": "JWS",
                  "value": "JWS"
                },
                {
                  "name": "Maddocks",
                  "value": "Maddocks"
                },
                {
                  "name": "Chapman Tripp",
                  "value": "Chapman Tripp"
                },
                {
                  "name": "Simpson Grierson",
                  "value": "Simpson Grierson"
                },
                {
                  "name": "McInnes Wilson",
                  "value": "McInnes Wilson"
                },
                {
                  "name": "Seyfarth",
                  "value": "Seyfarth"
                }
              ],
              "readOnly": false,
              "removed": true
            },
            {
              "id": "LinkedIn Search Query",
              "displayName": "LinkedIn Search Query",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "Likely Role",
              "displayName": "Likely Role",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "Seniority",
              "displayName": "Seniority",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "options",
              "options": [
                {
                  "name": "Senior",
                  "value": "Senior"
                },
                {
                  "name": "Mid-Senior",
                  "value": "Mid-Senior"
                },
                {
                  "name": "Mid",
                  "value": "Mid"
                }
              ],
              "readOnly": false,
              "removed": true
            },
            {
              "id": "Relevance",
              "displayName": "Relevance",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "options",
              "options": [
                {
                  "name": "High",
                  "value": "High"
                },
                {
                  "name": "Medium",
                  "value": "Medium"
                }
              ],
              "readOnly": false,
              "removed": true
            },
            {
              "id": "LinkedIn profile",
              "displayName": "LinkedIn profile",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "Full Name",
              "displayName": "Full Name",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Role",
              "displayName": "Role",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Org",
              "displayName": "Org",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "LinkedIN",
              "displayName": "LinkedIN",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Location",
              "displayName": "Location",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "verification",
              "displayName": "verification",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Background",
              "displayName": "Background",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Legal Tech Interest",
              "displayName": "Legal Tech Interest",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        304,
        1008
      ],
      "id": "03444c7f-7156-47bf-b228-459ecf8b138c",
      "name": "Airtable Write1",
      "credentials": {
        "airtableTokenApi": {
          "id": "LVF892xkQD72QD7v",
          "name": "Airtable - Leonard @ Legal Engine"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.perplexity.ai/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"sonar\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Act as an elite business intelligence analyst covering the UK professional services sector. Your task is to research a named attendee a legal and professional services Webinar event and produce a thorough and accurate professional background. Write in UK English. Avoid conjecture. Prioritise recent and reputable sources. Cross check titles and employment against at least two independent references where possible. Prefer the person's current employer website, LinkedIn, and recent press. If a detail cannot be verified, omit it from narrative rather than inventing it.\\n\\nOutput requirements. Return exactly the JSON object described in the user message. Do not include markdown. Do not include commentary. Do not include extra fields. The background section must be at least 300 words. The legalTechInterest section must be 50 words. Keep tone factual, concise, and professional.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Research this attendee and produce a rigorous background profile and targeted interest note.\\n\\nInputs.\\n- Full Name.{{ $json.Name }} \\n- Email. {{ $json.Email }}\\n- LinkedIn Profile. {{ $json['LinkedIn profile'] }}\\n- Role. {{ $json['Likely Role'] }}\\n- Organisation or Firm. {{ $json.Firm }}\\n\\n Research protocol.\\n1) Prefer LinkedIn profile as the main source of information and then employer website bio pages, reputable press and trade publications, legal and marketing industry outlets. Provide a 50 word paragraph on how this attendee may be interested in legal technology and Legal Engine, grounded in their role and responsibilities. Focus on business development, marketing operations, experience capture, knowledge reuse, proposal automation, and client development where relevant.\\n\\nReturn only this JSON object.\\n{\\n  \\\"fullName\\\": \\\"\\\",\\n  \\\"role\\\": \\\"\\\",\\n  \\\"organisation\\\": \\\"\\\",\\n  \\\"linkedin\\\": \\\"string or 'no info'\\\",\\n  \\\"currentofficeLocation\\\": \\\"string or 'no info'\\\",\\n  \\\"verification\\\": {\\n    \\\"isCurrentRoleVerified\\\": true,\\n    \\\"verifiedOn\\\": \\\"ISO date\\\",\\n    \\\"sources\\\": [\\\"primary source URL\\\", \\\"secondary source URL\\\"]\\n  },\\n  \\\"background300Words\\\": \\\"300+ word narrative profile of background and experience. factual and sourced. no bullet points.\\\",\\n  \\\"legalTechInterest50Words\\\": \\\"50 word paragraph on likely interest in legal tech and Legal Engine based on responsibilities\\\"\\n}\"\n    }\n  ],\n  \"max_tokens\": 2200,\n  \"temperature\": 0.2,\n  \"top_p\": 0.9,\n  \"presence_penalty\": 0,\n  \"frequency_penalty\": 0,\n  \"search_recency_filter\": \"year\",\n  \"search_domain_filter\": [\n    \"linkedin.com\",\n    \"thelawyer.com\",\n    \"law.com\",\n    \"legalbusiness.co.uk\",\n    \"lawgazette.co.uk\",\n    \"psmg.co.uk\",\n    \"netlawmedia.com\",\n    \"pressreleases.responsesource.com\",\n    \"prnewswire.com\",\n    \"businesswire.com\",\n    \"globenewswire.com\",\n    \"eventbrite.co.uk\",\n    \"companieshouse.gov.uk\",\n    \"chambers.com\",\n    \"legal500.com\",\n    \"globallegalpost.com\",\n    \"rollonfriday.com\",\n    \"legalcheek.com\",\n    \"slideshare.net\",\n    \"youtube.com\"\n  ]\n}\n",
        "options": {}
      },
      "id": "4105f41c-36ac-445c-93ef-3e9d03705463",
      "name": "Perplexity LinkedIn",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -608,
        992
      ],
      "typeVersion": 4.2,
      "credentials": {
        "httpHeaderAuth": {
          "id": "Ok9KPJP4UMw6OLgP",
          "name": "Unnamed credential"
        }
      }
    }
  ],
  "connections": {
    "When clicking Test workflow1": {
      "main": [
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Emails": {
      "main": [
        [],
        [
          {
            "node": "Perplexity LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date Format1": {
      "main": [
        [
          {
            "node": "Airtable Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "main": [
        [
          {
            "node": "Date Format1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable Source": {
      "main": [
        [
          {
            "node": "Loop Over Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Loop Over Emails",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "PP Flattening",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PP Flattening": {
      "main": [
        [
          {
            "node": "Airtable Write1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable Write1": {
      "main": [
        [
          {
            "node": "Loop Over Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Perplexity LinkedIn": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 0,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}